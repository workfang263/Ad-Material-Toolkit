# 快速参考 - 阶段七准备

**日期**：2025年12月27日  
**当前进度**：已完成阶段一到阶段六（6/8阶段，75%）  
**下一步**：阶段七 - 表格生成改造

---

## 一、项目概述

### 项目目标
实现广告投放新需求技术方案，包括：
- Excel表格导入功能（筛选"商品属性*"为"M"的行）
- 图片拼接外链同步到广告投放页面
- 数据对应关系管理（外链 ↔ 图片链接 ↔ 商品ID/SPU）
- 智能对齐功能（按3:1规则生成表格）
- 双模式架构（标准模式 + 拼图对齐模式）

### 核心功能架构
```
┌─────────────────────────────────────┐
│  工作流模式切换（workflowMode）        │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────┐                │
│  │  标准模式        │                │
│  │  (standard)     │                │
│  │                 │                │
│  │  ✅ Excel导入    │ ← 基础功能层   │
│  │  ✅ 轮播视频模式   │                │
│  │  ✅ 1:1生成表格   │                │
│  └─────────────────┘                │
│                                     │
│  ┌─────────────────┐                │
│  │  拼图对齐模式    │                │
│  │  (stitch_sync)   │                │
│  │                 │                │
│  │  ✅ Excel导入    │ ← 基础功能层   │
│  │  ✅ 外链同步      │                │
│  │  ✅ 数据对齐      │                │
│  │  ✅ 3:1强校验    │                │
│  │  ⏳ 3:1生成表格   │ ← 阶段七      │
│  └─────────────────┘                │
└─────────────────────────────────────┘
```

---

## 二、已完成阶段总结

### ✅ 阶段一：基础工具和配置
- 安装依赖（xlsx、pinia-plugin-persistedstate）
- 配置Pinia持久化插件
- 创建URL归一化工具函数

### ✅ 阶段二：Store结构设计
- 修改 `adCampaign.js` store，添加新模式相关状态
- 修改 `imageStitch.js` store，增强addMaterial方法
- 实现模式切换逻辑、同步来源标记、数据映射

### ✅ 阶段三：Excel导入功能
- Excel解析、自动表头识别、手动映射、导入预览
- 数据筛选（商品属性* === "M"）
- 建立映射和素材标签

### ✅ 阶段四：工作流模式UI
- 模式切换开关
- UI显示/隐藏逻辑
- 布局调整

### ✅ 阶段五：图片拼接页面改造
- 增强槽位数据结构
- 外链同步功能
- 去重检查

### ✅ 阶段六：对齐功能（已完成 + 优化）
- 对齐预览表组件（支持折叠/展开）
- 实时监听文本框变化（防抖优化）
- 以链接为锚点的状态检测（位置敏感型解析）
- 智能对齐逻辑（补全缺失、替换不匹配、删除多余）

---

## 三、核心技术点（重要）

### 1. 位置敏感型解析（核心优化）

**问题**：数组索引与位置不匹配，用户删除行后位置错乱

**解决方案**：
```javascript
const parseFormSection = (text, expectedTotal) => {
  const lines = text.split('\n').map(line => line.trim())
  
  // 关键：补齐长度，确保用户删掉末尾行时，数组长度不缩短
  while (lines.length < expectedTotal) {
    lines.push('')
  }
  
  return lines.slice(0, expectedTotal)
}

// 使用位置索引获取数据
for (let i = 0; i < 3; i++) {
  const pos = startIndex + i  // 使用位置索引，而不是 slice
  const formId = currentIds[pos] || ''
}
```

**代码位置**：
- `handleAlignData`：第 2095-2110 行
- `alignmentStatus`：第 2390-2407 行

---

### 2. 以表单为准的设计理念

**核心思路**：
```
表单（文本框） → 主数据源
Store（映射表） → 辅助数据源（用于查找和补全）
```

**工作流程**：
1. 解析表单中的外链（主数据源）
2. 以表单外链为准，查找 Store 中对应的商品信息
3. 检测缺失的数据，从 Store 中补全
4. 用 Store 数据替换不匹配的数据

---

### 3. 三种状态的检测逻辑

**状态定义**：
- **匹配**：表单数据 = Store 数据（绿色）
- **缺失**：表单数据为空（红色）
- **修改**：表单数据 ≠ Store 数据（黄色）

**检测逻辑**：
```javascript
const isIdEmpty = !formId || formId.trim() === ''
const isSpuEmpty = !formSpu || formSpu.trim() === ''

if (isIdEmpty || isSpuEmpty) {
  status = 'missing'  // 缺失
} else if (formId !== expectedId || formSpu !== expectedSpu) {
  status = 'modified'  // 修改
} else {
  status = 'matched'  // 匹配
}
```

---

## 四、阶段七：表格生成改造（下一步）

### 4.1 目标

1. **3:1分组逻辑（拼图对齐模式）**
   - 每3个商品ID/SPU对应1个外链
   - 商品ID和商品SPU用逗号连接

2. **1:1逻辑（标准模式）**
   - 保持原有的1:1对应关系
   - 保留轮播视频模式功能

3. **校验拦截**
   - 在生成表格前进行校验
   - 校验失败时阻止生成并提示用户

4. **文件命名优化**
   - 文件名包含时间戳和操作人信息
   - 格式：`投放表_{操作人}_{时间戳}.xlsx`

### 4.2 相关文件

- `frontend/src/views/AdCampaign.vue`（`generateAllTables` 方法）

### 4.3 技术要点

1. **模式判断**：根据 `workflowMode` 选择不同的生成逻辑
2. **3:1分组**：`formLinks.length` 个外链，每个对应3个商品
3. **1:1对应**：保持原有的1:1逻辑
4. **校验前置**：在生成前进行校验，失败时阻止

---

## 五、关键代码位置索引

### Store 方法
- `adCampaign.js`：
  - `handleModeChange` - 模式切换
  - `buildImageToProductMapping` - 建立映射关系
  - `scanAndTagMaterials` - 扫描素材库并打标签
  - `addExternalLink` - 添加外链（智能切换）
  - `alignData` - 数据对齐（旧方法，已优化为 handleAlignData）
  - `validateStrictThree` - 三倍数强校验
  - `validateRowCountMatch` - 行数相等校验
  - `checkAlignmentStatus` - 对齐状态检测（旧方法，已优化为 alignmentStatus computed）

### 页面方法（AdCampaign.vue）
- `handleModeChange` - 模式切换处理
- `handleExcelImport` - Excel导入处理
- `handleAlignData` - **智能对齐方法（第 2040-2285 行）** ⭐
- `alignmentStatus` - **对齐状态计算属性（第 2325-2576 行）** ⭐
- `debounce` - 防抖工具函数（第 2238-2280 行）
- `parseFormSection` - 位置敏感型解析函数（第 2095-2110 行）⭐
- `generateAllTables` - **表格生成方法（需要改造）** ⏳

---

## 六、开发风格要求

### 角色定位
- **AI 助手角色**：一个有十年全栈经验年薪百万的全栈工程师
- **对前后端都非常了解**
- **具有教学精神**，能够详细解释代码和技术原理

### 开发流程
1. **不擅自操作**：在执行任何操作前，先询问用户是否要执行
2. **过程详细**：每个步骤都要详细说明
3. **有教学感觉**：让用户能学会、学到知识
4. **循序渐进**：一步一步完成项目，不能跳过步骤

### 代码风格
- **保持一致性**：参考项目现有代码风格
- **注释清晰**：核心代码要有清晰的注释
- **命名规范**：使用清晰的变量和函数名
- **错误处理**：完善错误处理和用户提示

---

## 七、重要注意事项

### 1. Excel导入相关
- ✅ 使用"商品主图"列（不是"商品图片链接"列）
- ✅ 筛选条件：商品属性* === "M"
- ✅ 商品主图多个URL时，只取第一个

### 2. 功能隔离
- ✅ 标准模式：保留所有原有功能，包括轮播视频模式
- ✅ 拼图对齐模式：启用新功能，3:1强校验
- ✅ Excel导入：基础功能层，两种模式都可用

### 3. 数据流程
```
Excel导入 → 建立映射 → 扫描素材库打标签
素材上传 → 自动扫描映射表 → 打标签
拼图完成 → 外链同步 → 数据对齐 → 生成表格（阶段七）
```

### 4. 位置敏感型解析（重要）
- ✅ 补齐数组长度到预期值（`formLinks.length * 3`）
- ✅ 不过滤空值，保留空行
- ✅ 使用位置索引（`startIndex + i`）获取数据，而不是 `slice`

---

## 八、参考文档

### 方案文档
- `pinjie/广告投放新需求方案-最终完美版.md` - 完整技术方案
- `pinjie/数据对齐功能优化方案.md` - 对齐功能优化方案
- `pinjie/数据对齐逻辑问题分析.md` - 问题分析和解决方案（已解决）

### 开发规范
- `cursor的对话风格` - 对话风格和角色定位
- `pinjie/开发风格和要求.md` - 开发风格要求

### 会话总结
- `pinjie/会话总结-2025-12-27-数据对齐优化.md` - 本次会话总结

---

## 九、下一步工作

### 阶段七：表格生成改造

**需要实现**：
1. 3:1分组逻辑（拼图对齐模式）
2. 1:1逻辑（标准模式）
3. 校验拦截
4. 文件命名优化

**预计时间**：1-2小时

**开始方式**：
在新窗口中，告诉AI：
"请查看项目开发总结文件和会话总结文件，继续开发阶段七：表格生成改造"

---

**最后更新**：2025年12月27日  
**文档版本**：v1.0

