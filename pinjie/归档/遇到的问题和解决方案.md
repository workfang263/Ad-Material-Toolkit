# 图片拼接素材工具 - 遇到的问题和解决方案

## 问题记录

### 问题 1：Element Plus 组件无法识别

**问题描述：**
- 错误信息：`Failed to resolve component: el-button` 和 `Failed to resolve component: el-input`
- 原因：Element Plus 没有在 main.js 中全局注册

**解决方案：**
在 `frontend/src/main.js` 中添加：
```javascript
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
app.use(ElementPlus)
```

**相关文件：**
- `frontend/src/main.js`

---

### 问题 2：画布布局显示不正确

**问题描述：**
- 左侧大图没有正确跨越两行
- 布局不符合预期的 2x2 网格（左侧大图，右侧上下两个小图）

**解决方案：**
在 CSS 中为左侧槽位添加 `grid-row: span 2`：
```css
.left-slot {
  grid-row: span 2; /* 占据两行 */
}
```

**相关文件：**
- `frontend/src/views/ImageStitch.vue` (CSS 部分)

---

### 问题 3：CORS 跨域问题（图片无法显示）

**问题描述：**
- 错误信息：`ERR_BLOCKED_BY_RESPONSE.NotSameOrigin`
- 图片已成功下载，但浏览器无法显示
- 前端运行在 18080，图片 URL 是 18083，导致跨域

**解决方案：**
1. 在 `frontend/vite.config.js` 中添加 `/temp` 路径的代理：
```javascript
'/temp': {
  target: 'http://localhost:18083',
  changeOrigin: true
}
```

2. 在前端代码中使用相对路径而不是完整 URL：
```javascript
previewUrl: localPath // 使用 '/temp/xxx.jpg' 而不是完整 URL
```

**相关文件：**
- `frontend/vite.config.js`
- `frontend/src/views/ImageStitch.vue`

---

## 经验总结

### 开发过程中的注意事项

1. **端口配置问题**
   - 前端开发服务器：18080
   - API 网关：18083
   - Python 服务：18090
   - 注意代理配置，确保跨域请求正确转发

2. **静态文件服务**
   - 后端静态文件需要配置代理或 CORS
   - 推荐使用代理方式，更简单可靠

3. **Element Plus 使用**
   - 需要在 main.js 中全局注册
   - 或者使用按需导入（需要配置）

4. **CSS Grid 布局**
   - 使用 `grid-row: span 2` 可以让元素跨越多行
   - `grid-template-columns: 2fr 1fr` 实现不等宽列

5. **HTML5 拖拽 API**
   - `draggable="true"` 启用拖拽
   - `@dragover.prevent` 必须调用 preventDefault 才能放置
   - `dataTransfer.setData/getData` 用于传递数据
   - `dragstart`、`dragend`、`dragover`、`dragleave` 事件的生命周期

6. **错误处理最佳实践**
   - 错误分类：从具体到通用（超时 → 网络 → HTTP → 通用）
   - 用户友好提示：技术错误转换为中文
   - 操作建议：在错误消息中提供解决方法

7. **会话隔离技术**
   - Session ID 获取：从请求头或 Cookie
   - 目录隔离：`public/temp/{sessionId}/`
   - 路径格式：`/temp/{sessionId}/filename.jpg`
   - 向后兼容：支持新旧两种路径格式

### 问题 4：Python 服务超时和 404 错误

**问题描述：**
- 前端请求 `/api/video-generation/api/process/stitch` 返回 404
- API 网关显示超时错误（`timeout of 60000ms exceeded`）
- Python 服务无法响应请求

**原因分析：**
- Python 服务可能没有运行
- 接口路径不匹配
- 多个服务实例冲突（端口 18090 有多个进程）

**解决方案：**
1. 检查 Python 服务是否运行：`netstat -ano | findstr :18091`
2. 重启 Python 服务
3. 验证接口代码是否正确添加
4. 用户将端口从 18090 改为 18091，避免冲突

**相关文件：**
- `video-service/app.py`
- `api-gateway/server.js`

---

### 问题 5：Clipboard API 不支持

**问题描述：**
- 复制链接时错误：`TypeError: Cannot read properties of undefined (reading 'writeText')`
- `navigator.clipboard` 为 `undefined`

**原因分析：**
- Clipboard API 需要安全上下文（HTTPS 或 localhost）
- 使用局域网 IP（`192.168.0.67`）访问时，浏览器可能限制 Clipboard API

**解决方案：**
1. 添加 Clipboard API 存在性检查
2. 实现降级方案：使用 `document.execCommand('copy')`
3. 支持 iOS 设备的特殊处理（使用 `setSelectionRange`）

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第 440-507 行）

---

### 问题 6：ElMessage 不支持多行显示

**问题描述：**
- 错误消息使用 `\n` 换行符，但 Element Plus 的 `ElMessage` 不支持多行显示
- 换行符被当作普通字符显示

**解决方案：**
- 将错误消息合并为单行，使用冒号分隔
- 格式：`错误标题：详细描述`

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第 331-334 行，第 520-523 行）

---

### 问题 7：端口配置修改

**问题描述：**
- 用户将 Python 服务端口从 18090 改为 18091
- 需要确保配置一致性

**解决方案：**
- 检查端口占用情况：`netstat -ano | findstr :18091`
- 验证配置一致性：
  - `video-service/app.py`：端口 18091
  - `api-gateway/server.js`：服务地址 `http://localhost:18091`

**经验总结：**
- 修改端口前要先检查冲突
- 确保所有相关配置同步更新
- 不能擅自修改端口，必须先询问用户

---

### 问题 8：布局太大，用户体验不好

**问题描述：**
- 原布局：上下布局（素材库在上，画布在下），尺寸调整面板在画布下方
- 问题：布局占用空间大，画布预览区显示不完整，需要滚动
- 生成结果区域在画布下方，显得拥挤

**解决方案：**
1. **重构为三栏布局**
   - 左侧：素材区（固定340px）
   - 中间：画布预览区（flex: 1，自适应）
   - 右侧：布局参数面板（固定260px）

2. **画布自适应缩放**
   - 实现 `canvasGridStyleWithScale` 计算属性
   - 使用 `transform: scale()` 等比例缩小显示
   - 自动计算缩放比例，确保画布完整显示
   - **关键**：只缩小不放大（scale <= 1），不影响实际生成尺寸

3. **生成结果区域优化**
   - 从画布下方移到右侧布局参数面板下方
   - 更紧凑的样式设计

4. **移除页面大标题**
   - 完全移除，节省垂直空间

**技术实现：**
```javascript
// 计算缩放比例
const containerWidth = canvasWrapper.value.clientWidth - 24
const containerHeight = canvasWrapper.value.clientHeight - 24
const scaleX = (containerWidth * 0.9) / canvasWidth
const scaleY = (containerHeight * 0.9) / canvasHeight
const scale = Math.min(scaleX, scaleY, 1) // 不超过100%

// 应用缩放
transform: `scale(${scale})`
```

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第 359-395 行，第 1204-1222 行）

---

### 问题 9：画布预览区显示不完整

**问题描述：**
- 画布尺寸较大时，出现滚动条
- 无法完整看到画布布局
- 影响用户体验

**解决方案：**
- 实现画布自适应缩放功能
- 使用 `transform: scale()` 等比例缩小显示
- 自动计算缩放比例，确保完整显示
- **重要**：只缩小不放大，不影响实际生成尺寸

**技术要点：**
- CSS Transform缩放：`transform: scale(ratio)`
- 自适应算法：`Math.min(scaleX, scaleY, 1)`
- 缩放原点：`transform-origin: center center`

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第 359-395 行）

---

### 问题 10：素材库图片太大，需要滚动

**问题描述：**
- 素材卡片尺寸150px，一屏只能显示2-3个
- 需要滚动才能找到素材进行拖拽
- 用户体验不好

**解决方案：**
- 缩小卡片尺寸：150px → 90px
- 减小间距：16px → 12px
- 优化细节：卡片圆角、按钮padding等

**效果：**
- 一屏显示素材数量增加约60-80%
- 减少滚动操作
- 保持拖拽功能正常

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第 1327-1376 行）

---

### 问题 11：后端未使用传入的尺寸参数

**问题描述：**
- 前端正确发送了尺寸参数（600×300, 300×200, 300×200）
- 后端接收到了参数，但生成的图片仍然是默认尺寸（1200×800）
- 控制台显示尺寸不匹配警告

**原因分析：**
- 后端代码没有重新加载，仍在使用旧代码
- 需要重启 Python 服务以加载新代码

**解决方案：**
1. 重启 Python 服务
2. 添加详细的调试日志，确认参数接收和使用情况
3. 验证尺寸参数是否正确传递和使用

**相关文件：**
- `video-service/app.py`（第1230-1490行）

---

### 问题 12：404 错误 - 接口路由问题

**问题描述：**
- 前端请求 `/api/video-generation/api/process/stitch` 返回 404
- API 网关没有正确转发请求

**原因分析：**
- API 网关代码没有重新加载
- 需要重启 API 网关服务

**解决方案：**
- 重启 API 网关服务
- 添加调试日志，确认请求转发情况

**相关文件：**
- `api-gateway/server.js`

---

### 问题 13：文件路径不一致导致 404

**问题描述：**
- Python 服务接收到了请求，但文件不存在
- 图片路径：`/temp/sid_shared_default/xxx.jpg`
- Python 服务使用的 Session ID：`01f2fb134160985e3313d158418fb1cf`（从 Cookie 获取）

**原因分析：**
- 图片下载接口返回的路径不包含 Session ID：`/temp/${filename}`
- Python 服务期望的路径格式：`/temp/{sessionId}/filename.jpg`
- Session ID 不一致导致文件找不到

**解决方案：**
1. **修复图片下载接口**：返回包含 Session ID 的路径
   ```javascript
   const localPathWithSession = `/temp/${sessionId}/${filename}`;
   ```

2. **修复 Python 服务路径解析**：正确处理包含 Session ID 的路径
   ```python
   if '/' in relative:
       # 新格式：{sessionId}/filename.jpg
       path_session_id = parts[0]
       filename = parts[-1]
       file_session_dir = os.path.join(PROJECT_ROOT, 'api-gateway', 'public', 'temp', path_session_id)
       return os.path.join(file_session_dir, filename)
   ```

**相关文件：**
- `api-gateway/server.js`（第2156-2161行）
- `video-service/app.py`（第1379-1397行）

---

### 问题 14：保存目录不存在导致 500 错误

**问题描述：**
- Python 服务处理成功，但保存图片时失败
- 错误：`FileNotFoundError: [Errno 2] No such file or directory`
- 保存路径使用的 Session ID 与图片路径中的 Session ID 不一致

**原因分析：**
- 图片存储在 `sid_shared_default` 目录
- 保存时使用了 Python 服务从 Cookie 获取的 Session ID（`01f2fb134160985e3313d158418fb1cf`）
- 该目录不存在，导致保存失败

**解决方案：**
1. **使用图片路径中的 Session ID 保存**：
   ```python
   # 从图片路径中提取 Session ID
   if '/' in left_path.split('/temp/')[-1]:
       output_session_id = left_path.split('/temp/')[-1].split('/')[0]
   else:
       output_session_id = session_id
   ```

2. **确保输出目录存在**：
   ```python
   output_temp_dir = os.path.join(PROJECT_ROOT, 'api-gateway', 'public', 'temp', output_session_id)
   os.makedirs(output_temp_dir, exist_ok=True)
   ```

**相关文件：**
- `video-service/app.py`（第1460-1481行）

---

### 问题 15：控制台输出显示 Object，无法查看具体数值

**问题描述：**
- 控制台输出显示 `Object`，无法查看具体的尺寸数值
- 无法准确验证尺寸是否匹配

**解决方案：**
- 改进日志输出格式，显示具体数值而不是对象
- 添加详细的尺寸验证信息
- 在生成结果区域显示尺寸信息

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第1004-1152行）

---

### 问题 16：生成的图片不是1:1正方形

**问题描述：**
- 虽然尺寸显示是1200×1200，但实际生成的图片是1200×1000
- 前端发送的尺寸（900×1000, 300×300, 300×300）计算出的画布是1200×1000

**原因分析：**
- 前端没有在生成前调用调整函数
- 默认值（900×1000, 300×300, 300×300）计算出的画布不是正方形

**解决方案：**
1. 在生成前调用 `getAdjustedSizesForSquare()` 获取调整后的尺寸
2. 使用调整后的尺寸传递给后端
3. 优化默认值为 800×800, 400×400, 400×400

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第1011行）
- `frontend/src/stores/imageStitch.js`（第240-304行）

---

### 问题 17：默认值导致画布不是正方形

**问题描述：**
- 默认值 900×1000, 300×300, 300×300 计算出的画布是1200×1000（不是正方形）

**解决方案：**
- 修改默认值为 800×800, 400×400, 400×400
- 虽然初始计算是1200×800，但自动调整后会变成1200×1200

**相关文件：**
- `frontend/src/stores/imageStitch.js`（第15-25行）

---

### 问题 18：调整策略导致布局不协调

**问题描述：**
- 初始策略：只增加左侧高度，导致左侧变成竖向矩形（如800×1200）
- 视觉上不协调，看起来像横向矩形

**解决方案：**
- 优化调整策略：高度不足时，同时增加左侧和右侧高度
- 右侧两个区域等分高度增量，让布局更平衡

**相关文件：**
- `frontend/src/stores/imageStitch.js`（第283-302行）

---

### 问题 19：结果图片显示不是正方形

**问题描述：**
- 虽然尺寸是1200×1200，但CSS显示时看起来像矩形

**解决方案：**
- 添加 `aspect-ratio: 1` CSS属性，强制1:1显示
- 优化容器样式，确保正确显示

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第1562-1568行）

---

## 待解决的问题

### 问题 1：视觉效果仍需改善

**问题描述：**
- 虽然生成的图片是1:1正方形且无留白
- 但视觉上可能还不够协调，需要进一步优化布局比例

**可能的原因：**
- 左侧图片是竖向矩形（800×1200），视觉上不够平衡
- 右侧两个区域的高度分配可能需要优化
- 整体布局比例可能需要调整

**建议的改进方向：**
1. 尝试不同的默认值组合，找到更协调的比例
2. 优化调整策略，让三个区域的尺寸更平衡
3. 考虑让左侧更接近正方形（如1000×1000），右侧相应调整
4. 可能需要调整布局方式，让整体看起来更像正方形

**相关文件：**
- `frontend/src/stores/imageStitch.js`（第15-25行，第240-304行）

---

### 问题 20：imageSizes 改为计算属性后，旧方法无法直接修改

**问题描述：**
- `imageSizes` 从 `reactive` 改为 `computed` 后，旧方法（如 `adjustRightSizesForSquare`）无法直接修改
- 某些方法试图直接修改 `imageSizes.left.width`，但计算属性是只读的
- 导致旧方法无法正常工作

**原因分析：**
- 计算属性是只读的，不能直接赋值
- 旧方法设计时假设 `imageSizes` 是可写的 `reactive` 对象
- 比例系统重构后，数据流发生了变化

**解决方案：**
1. **修复旧方法**：使用 `.value` 访问计算属性（只读），添加TODO注释说明需要重构
2. **添加新方法**：创建更新方法（`updateSplitXFromLeftWidth`、`updateSplitYFromTopRightHeight`、`updateCanvasSize`），通过修改比例来实现
3. **后续重构**：逐步将旧方法改为使用比例系统

**相关文件：**
- `frontend/src/stores/imageStitch.js`（第202-250行）- 旧方法修复
- `frontend/src/stores/imageStitch.js`（第97-165行）- 新更新方法

**技术要点：**
- 计算属性是只读的，需要通过修改源数据（比例）来更新
- 反向计算：从像素值计算比例 = 像素值 / 总尺寸
- 单一数据源：比例系统是唯一的数据源，像素值由计算属性自动计算

---

### 问题 21：拖动逻辑需要重构为使用比例系统 ✅ 已解决

**问题描述：**
- 当前拖动逻辑仍使用旧的像素值方式
- 拖动时计算像素值，然后更新像素值，容易出错
- 需要处理缩放比例，逻辑复杂

**解决方案（已实现）：**
1. **使用比例计算**：拖动时直接计算比例（0.0-1.0），而不是像素值
2. **添加吸附功能**：当接近0.5时自动吸附（阈值2%）
3. **使用全局事件监听**：使用 `window` 而不是 `document`，确保鼠标移出画布也能继续拖动
4. **优化鼠标样式**：拖动时锁定鼠标手势，提供视觉反馈

**相关文件：**
- `frontend/src/views/ImageStitch.vue`（第1038-1376行）- 拖动逻辑（已重构）

**技术要点：**
- 比例计算：`newSplitX = (e.clientX - rect.left) / rect.width`
- 吸附功能：`if (Math.abs(newSplitX - 0.5) < 0.02) { newSplitX = 0.5 }`
- 全局事件监听：`window.addEventListener('mousemove', handleVerticalDrag)`

---

### 问题 22：外链上传接口返回 404 错误 ✅ 已解决

**问题描述：**
- 前端调用 `/api/upload-to-imgfi` 接口时返回 404
- 接口已定义，但无法访问

**原因分析：**
- 服务没有重启，新代码没有生效
- Node.js 服务修改代码后需要重启才能生效

**解决方案：**
- 重启 API 网关服务，让新代码生效
- 添加调试日志，确认接口被调用

**知识点：**
- Node.js 服务修改代码后需要重启才能生效
- 使用 nodemon 可以自动重启（开发模式）

**相关文件：**
- `api-gateway/server.js`（第3439行）- 上传接口

---

### 问题 23：外链上传接口返回 500 错误 ✅ 已解决

**问题描述：**
- 接口可以访问（不再是 404），但返回 500 内部服务器错误
- 前端错误信息：`POST http://localhost:18080/api/upload-to-imgfi 500 (Internal Server Error)`
- 错误响应显示：`上传成功，但未获取到外链 URL`

**根本原因：**
- imgfi.com 的响应结构中，URL 在 `response.data.image.url`，而不是 `response.data.url`
- 后端代码检查的是错误的路径（`response.data.url`），导致无法提取 URL
- 虽然上传成功，但因为无法提取 URL，返回了 500 错误

**解决方法：**
1. **查看 API 文档**：
   - 访问 `https://imgfi.com/api-v1` 查看官方 API 文档
   - 了解正确的响应结构格式

2. **修复响应解析逻辑**：
   ```javascript
   // 修复前：检查 response.data.url（错误）
   if (response.data && response.data.url) {
     const imgfiUrl = response.data.url;
   }
   
   // 修复后：检查 response.data.image.url（正确）
   let imgfiUrl = null;
   if (response.data.image && response.data.image.url) {
     imgfiUrl = response.data.image.url;  // 优先路径
   } else if (response.data.image && response.data.image.image && response.data.image.image.url) {
     imgfiUrl = response.data.image.image.url;  // 备选路径
   }
   ```

3. **增强容错处理**：
   - 提供多个备选路径，增强容错性
   - 添加详细的调试日志，显示从哪个路径获取的 URL

**修复结果：**
- ✅ 外链上传功能正常工作
- ✅ 功能测试通过
- ✅ 可以成功获取外链 URL 并复制

**知识点：**
- **API 响应结构解析**：不同 API 的响应结构可能不同，需要查看官方文档
- **防御性编程**：提供多个备选路径，增强容错性
- **错误处理**：错误处理要输出完整信息，便于调试
- **API 文档查找**：可以通过搜索引擎或访问服务官网查找 API 文档

**相关文件：**
- `api-gateway/server.js`（第3505-3531行）- 上传接口（已修复）
- `api-gateway/.env` - 环境变量配置

**技术要点：**
- 500 错误通常是服务器内部错误，需要查看详细日志
- 错误处理要输出完整信息，便于调试
- API Key 等敏感信息要安全存储，不要硬编码
- 查看 API 文档是解决问题的关键步骤


