# 图片拼接工具 - 快速参考（完整版）

**最后更新**：2025-12-25（第七次会话）  
**项目状态**：✅ 已完成（100%）

---

## 📋 当前状态

### ✅ 已完成功能（100%）

- ✅ 基础功能：页面框架、路由、Store、UI 组件
- ✅ 核心功能：图片下载、拖拽、拼接、生成
- ✅ 优化功能：错误处理、用户体验、加载状态
- ✅ 会话隔离：已验证通过
- ✅ 批量添加素材：已完成并验证
- ✅ 前端尺寸调整：已完成并验证
- ✅ 布局优化：三栏布局 + 自适应缩放
- ✅ 素材库优化：缩小卡片尺寸
- ✅ 后端支持动态尺寸：已完成并验证
- ✅ **1:1图片比例功能**：比例系统重构完成，确保画布始终是1:1正方形
- ✅ **优化视觉效果**：分割线悬停显示，宽大热区，吸附功能
- ✅ **外链上传功能**：上传到 imgfi.com，获取永久外链

---

## 🚀 快速开始

### 启动服务

```bash
# 前端服务（18080）
cd frontend
npm run dev

# API 网关（18083）
cd api-gateway
node server.js

# Python 服务（18091）
cd video-service
python app.py
```

### 访问地址

- 前端：http://localhost:18080/image-stitch
- API 网关：http://localhost:18083
- Python 服务：http://localhost:18091

---

## 📁 关键文件

### 前端

- `frontend/src/views/ImageStitch.vue` - 主页面（2509 行，所有功能已实现）
- `frontend/src/stores/imageStitch.js` - Pinia Store（506 行，比例系统已完成）
- `frontend/vite.config.js` - Vite 配置（包含 `/temp` 代理）
- `frontend/src/main.js` - Element Plus 全局注册

### 后端

- `api-gateway/server.js` - API 网关（3762 行，包含图片下载和外链上传接口）
- `api-gateway/.env` - 环境变量配置（包含 IMGFI_API_KEY，**请勿提交到版本控制**）
- `video-service/app.py` - 图片拼接接口（支持会话隔离和动态尺寸）
- `video-service/requirements.txt` - Python 依赖（包含 Pillow）

### 文档

- `pinjie/会话交接-2025-12-24-最新.md` - 会话交接文档（最重要！）
- `pinjie/会话总结-2025-12-24-第七次.md` - 最新会话总结
- `pinjie/项目状态-综合.md` - 项目状态综合文档
- `pinjie/遇到的问题和解决方案.md` - 问题记录
- `pinjie/开发风格和要求.md` - 开发规范

---

## 🔧 重要配置

### 端口配置

- 前端：18080
- API 网关：18083
- Python 服务：**18091**（已从 18090 修改）

### 目录结构

```
api-gateway/public/temp/
  ├── {sessionId1}/  (用户1的目录)
  │   ├── image1.jpg
  │   └── stitched_xxx.jpg
  ├── {sessionId2}/  (用户2的目录)
  │   └── image2.jpg
  └── ...
```

### 路径格式

- 新格式：`/temp/{sessionId}/filename.jpg`（用户隔离）
- 旧格式：`/temp/filename.jpg`（兼容性支持）

### 布局结构

```
┌─────────────────────────────────────────────────────────┐
│ 素材区 (340px) │ 画布预览区 (自适应) │ 布局参数 (260px) │
│               │                    │                  │
│ - URL输入     │ - 画布网格         │ - 主图尺寸       │
│ - 批量添加    │ (自适应缩放)       │ - 细节1尺寸      │
│ - 素材列表    │                    │ - 细节2尺寸      │
│ (90px卡片)    │                    ├──────────────────┤
│               │                    │ 生成结果         │
│               │                    │ [图片+复制链接]  │
│               │                    │ [外链上传]       │
└───────────────┴────────────────────┴──────────────────┘
```

---

## 💡 比例系统核心概念

### 比例系统（Ratio System）

**核心思想：**
- 存储比例系数（0.0-1.0），而不是绝对像素值
- 像素值由比例计算：`像素值 = 比例 × 总尺寸`
- 保证画布始终是1:1，无需额外调整逻辑

**数据结构：**
```javascript
const layoutRatios = reactive({
  splitX: 0.6667,    // 左侧占66.67%
  splitY: 0.5,       // 右上占50%
  canvasSize: 1200   // 画布总尺寸（1:1）
})
```

**计算属性：**
```javascript
const imageSizes = computed(() => {
  // 从比例自动计算像素值
  return {
    left: { width: size * splitX, height: size },
    // ...
  }
})
```

### 反向计算比例

**从像素值计算比例：**
```javascript
// 用户输入左侧宽度：600px
// 画布总尺寸：1200px
// 计算比例：600 / 1200 = 0.5
layoutRatios.splitX = 0.5
```

### 极端情况预防

**最小像素限制：**
```javascript
const MIN_PX = 100
const maxLeftWidth = size - MIN_PX
const clampedWidth = Math.max(MIN_PX, Math.min(maxLeftWidth, leftWidth))
```

### Store层更新方法

- `updateSplitXFromLeftWidth(leftWidth)` - 从左侧宽度更新 splitX
- `updateSplitYFromTopRightHeight(topRightHeight)` - 从右上高度更新 splitY
- `updateCanvasSize(newSize)` - 更新画布总尺寸（等比例缩放）

### View层实现

1. **拖动逻辑** ✅
   - 使用比例计算：`newSplitX = (e.clientX - rect.left) / rect.width`
   - 添加吸附功能（0.5处自动吸附，阈值2%）
   - 使用全局事件监听（window）

2. **输入框联动** ✅
   - 使用更新方法（updateSplitXFromLeftWidth, updateSplitYFromTopRightHeight）
   - 实现软性联动

3. **布局方式** ✅
   - 使用绝对定位（替代CSS Grid）
   - 使用 `aspect-ratio: 1/1` 强制1:1

---

## 📊 默认配置

### 默认尺寸（1:1正方形）

- **左侧主图**：800 × 1200（竖图，视觉冲击）
- **右上细节**：400 × 600
- **右下细节**：400 × 600
- **画布尺寸**：1200 × 1200 ✅ 完美的1:1正方形

### 比例系统配置

- `splitX = 0.6667`（左侧占66.67%，右侧占33.33%）
- `splitY = 0.5`（右上和右下各占50%）
- `canvasSize = 1200`（画布总尺寸，1:1正方形）

---

## 📡 接口列表

### 已实现接口

1. **POST /api/fetch-image** ✅
   - 功能：下载图片到本地
   - 请求：`{ "url": "https://..." }`
   - 响应：`{ "success": true, "localPath": "/temp/{sessionId}/xxx.jpg", "publicUrl": "...", "filename": "xxx.jpg" }`

2. **POST /api/process/stitch** ✅
   - 功能：图片拼接合成（支持动态尺寸和1:1比例）
   - 请求：`{ 
     "left": "/temp/{sessionId}/xxx.jpg", 
     "topRight": "...", 
     "bottomRight": "...",
     "leftSize": { "width": 800, "height": 1200 },
     "topRightSize": { "width": 400, "height": 600 },
     "bottomRightSize": { "width": 400, "height": 600 }
   }`
   - 响应：`{ "success": true, "imageUrl": "...", "localPath": "/temp/{sessionId}/stitched_xxx.jpg", "filename": "..." }`

3. **POST /api/upload-to-imgfi** ✅
   - 功能：上传图片到 imgfi.com，获取永久外链
   - 请求：`multipart/form-data`，字段名 `image`
   - 响应：`{ "success": true, "url": "https://s.imgfi.com/images/xxx.jpg" }`

---

## ⚠️ 注意事项

1. **开发风格要求**：
   - 必须严格按照 `pinjie/开发风格和要求.md` 执行
   - 先讲解再实现，先询问再操作
   - 每步完成后都要验证

2. **服务重启**：
   - 修改代码后需要重启对应的服务
   - Python 服务端口：18091
   - API 网关端口：18083

3. **布局结构**：
   - 三栏布局：素材区（340px）| 画布预览区（自适应）| 布局参数（260px）
   - 画布自适应缩放：自动等比例缩小显示，不影响实际生成尺寸
   - 生成结果：在右侧面板下方显示，包含尺寸信息和外链上传功能

4. **比例系统**：
   - 比例系统重构已完成（100%）
   - Store层：比例系统状态、计算属性、更新方法
   - View层：拖动逻辑、输入框联动、布局方式
   - 确保画布始终是1:1正方形

5. **路径格式**：
   - 图片路径格式：`/temp/{sessionId}/filename.jpg`
   - 确保前后端路径格式一致
   - 使用图片路径中的 Session ID 保存结果

6. **环境变量**：
   - `api-gateway/.env` 文件包含敏感信息（IMGFI_API_KEY）
   - 确保 `.env` 文件在 `.gitignore` 中
   - 不要提交 `.env` 文件到版本控制

---

## 📝 下次会话检查清单

1. [x] 查看最新会话总结：`pinjie/会话总结-2025-12-24-第七次.md`
2. [x] 检查所有服务是否正常运行
3. [x] 验证所有功能是否正常工作
4. [x] 项目已完成，所有功能正常运行

---

## 🔗 相关文档

- **项目状态**：`pinjie/项目状态-综合.md`
- **问题记录**：`pinjie/遇到的问题和解决方案.md`
- **开发规范**：`pinjie/开发风格和要求.md`
- **会话交接**：`pinjie/会话交接-2025-12-24-最新.md`
- **会话总结**：
  - `pinjie/会话总结-2025-12-24-第二次.md`（布局优化）
  - `pinjie/会话总结-2025-12-24-第三次.md`（动态尺寸功能）
  - `pinjie/会话总结-2025-12-24-第四次.md`（1:1图片比例）
  - `pinjie/会话总结-2025-12-24-第五次.md`（比例系统重构）
  - `pinjie/会话总结-2025-12-24-第六次.md`（比例系统重构完成）
  - `pinjie/会话总结-2025-12-24-第七次.md`（外链上传功能修复）

---

**文档版本**：v1.0  
**创建时间**：2025-12-25  
**最后更新**：2025-12-25（第七次会话）  
**维护者**：融合平台开发团队  
**项目状态**：✅ 已完成（100%）

