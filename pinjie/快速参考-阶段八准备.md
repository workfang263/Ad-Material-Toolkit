# 快速参考 - 阶段八准备

**日期**：2025年12月27日  
**当前进度**：已完成阶段一到阶段七（7/8阶段，87.5%）  
**下一步**：阶段八 - 测试和优化

---

## 一、项目概述

### 项目目标
实现广告投放新需求技术方案，包括：
- Excel表格导入功能（筛选"商品属性*"为"M"的行）
- 图片拼接外链同步到广告投放页面
- 数据对应关系管理（外链 ↔ 图片链接 ↔ 商品ID/SPU）
- 智能对齐功能（按3:1规则生成表格）
- 双模式架构（标准模式 + 拼图对齐模式）

### 核心功能架构
```
┌─────────────────────────────────────┐
│  工作流模式切换（workflowMode）        │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────┐                │
│  │  标准模式        │                │
│  │  (standard)     │                │
│  │                 │                │
│  │  ✅ Excel导入    │ ← 基础功能层   │
│  │  ✅ 轮播视频模式   │                │
│  │  ✅ 1:1生成表格   │                │
│  └─────────────────┘                │
│                                     │
│  ┌─────────────────┐                │
│  │  拼图对齐模式    │                │
│  │  (stitch_sync)   │                │
│  │                 │                │
│  │  ✅ Excel导入    │ ← 基础功能层   │
│  │  ✅ 外链同步      │                │
│  │  ✅ 数据对齐      │                │
│  │  ✅ 3:1强校验    │                │
│  │  ✅ 3:1生成表格   │ ← 已完成      │
│  └─────────────────┘                │
└─────────────────────────────────────┘
```

---

## 二、已完成阶段总结

### ✅ 阶段一：基础工具和配置
- 安装依赖（xlsx、pinia-plugin-persistedstate）
- 配置Pinia持久化插件
- 创建URL归一化工具函数

### ✅ 阶段二：Store结构设计
- 修改 `adCampaign.js` store，添加新模式相关状态
- 修改 `imageStitch.js` store，增强addMaterial方法
- 实现模式切换逻辑、同步来源标记、数据映射

### ✅ 阶段三：Excel导入功能
- Excel解析、自动表头识别、手动映射、导入预览
- 数据筛选（商品属性* === "M"）
- 建立映射和素材标签

### ✅ 阶段四：工作流模式UI
- 模式切换开关
- UI显示/隐藏逻辑
- 布局调整

### ✅ 阶段五：图片拼接页面改造
- 增强槽位数据结构
- 外链同步功能
- 去重检查

### ✅ 阶段六：对齐功能（已完成 + 优化）
- 对齐预览表组件（支持折叠/展开）
- 实时监听文本框变化（防抖优化）
- 以链接为锚点的状态检测（位置敏感型解析）
- 智能对齐逻辑（补全缺失、替换不匹配、删除多余）

### ✅ 阶段七：表格生成改造（已完成 + 校验优化）
- 校验拦截功能（validateRowCountMatch + validateStrictThree）
- 3:1分组逻辑（拼图对齐模式）
- 1:1逻辑（标准模式）
- 后端支持拼图对齐模式的3:1分组数据
- **核心优化**：基于"实时解析"的校验机制，Store作为静态字典

---

## 三、核心技术点（重要）

### 1. 基于"实时解析"的校验机制（阶段七新增）

**技术原理**：
- 引入解析层函数 `getFormLinks`，实时解析表单文本框
- 校验完全基于表单实时数据，不依赖 Store
- 确保校验反映用户当前操作

**代码位置**：
- `frontend/src/stores/adCampaign.js` 第 333-355 行（getFormLinks）
- `frontend/src/stores/adCampaign.js` 第 357-420 行（validateStrictThree）

---

### 2. Store 作为静态字典的设计理念（阶段七新增）

**核心思路**：
```
表单（文本框） → 主数据源（用于校验和计数）
Store（映射表） → 辅助数据源（用于查找和补全）
```

**工作流程**：
1. 校验：基于表单实时解析数据
2. 对齐：以表单外链为准，去 Store 中查找对应的商品信息
3. 查找：查得到就用，查不到就留白或提示
4. 持久性：Store 映射保留，即使表单删除链接，重新粘贴后仍能找回

---

### 3. 位置敏感型解析（阶段六核心优化）

**技术原理**：
- 补齐数组长度到预期值（`formLinks.length * 3`）
- 不过滤空值，保留空行
- 使用位置索引（`startIndex + i`）获取数据，而不是 `slice`

**优势**：
- 无论用户如何删除，位置索引永远正确
- 保持位置对应关系，不会错乱

**代码位置**：
- `handleAlignData` 方法：第 2095-2110 行
- `alignmentStatus` computed：第 2390-2407 行

---

## 四、阶段八：测试和优化（下一步）

### 8.1 目标

1. **功能测试**
   - Excel导入、外链同步、数据对齐、表格生成
   - 拼图对齐模式3:1分组逻辑完整流程测试
   - 标准模式1:1逻辑保持正常测试

2. **模式切换测试**
   - 标准模式和拼图对齐模式的切换
   - 确保功能隔离

3. **边界情况测试**
   - 空数据、数据不匹配、URL格式差异
   - 用户删除外链后重新同步的场景

4. **用户体验优化**
   - 提示信息、错误处理、加载状态
   - 文件保存错误的处理（InvalidStateError）

5. **性能优化**
   - 大量数据时的性能考虑

### 8.2 相关文件

- `frontend/src/views/AdCampaign.vue` - 主要测试页面
- `frontend/src/stores/adCampaign.js` - Store 测试
- `api-gateway/server.js` - 后端API测试

---

## 五、关键代码位置索引

### Store 方法（adCampaign.js）
- `getFormLinks` - 第 333-355 行（解析层函数，实时解析表单外链）
- `validateStrictThree` - 第 357-420 行（三倍数校验，基于表单实时数据）
- `validateRowCountMatch` - 第 422-445 行（行数相等校验）
- `handleModeChange` - 模式切换
- `buildImageToProductMapping` - 建立映射关系
- `scanAndTagMaterials` - 扫描素材库并打标签
- `addExternalLink` - 添加外链（智能切换）
- `alignData` - 数据对齐（旧方法，已优化为 handleAlignData）
- `checkAlignmentStatus` - 对齐状态检测（旧方法，已优化为 alignmentStatus computed）

### 页面方法（AdCampaign.vue）
- `handleModeChange` - 模式切换处理
- `handleExcelImport` - Excel导入处理
- `handleAlignData` - **智能对齐方法（第 2040-2285 行）** ⭐
- `alignmentStatus` - **对齐状态计算属性（第 2325-2576 行）** ⭐
- `generateAllTables` - **表格生成方法（第 1870-1905 行：校验拦截，第 1950-2037 行：生成逻辑）** ⭐
- `processBatchInput` - **数据分组方法（第 948-1110 行：3:1分组逻辑）** ⭐

### 后端方法（server.js）
- `processProductFields` - 第 745-810 行（处理商品字段，支持拼图对齐模式的3:1分组）⭐
- `generateABOData` - 生成ABO表格数据
- `generateURLRedirectData` - 生成URL重定向数据

---

## 六、开发风格要求

### 角色定位
- **AI 助手角色**：一个有十年全栈经验年薪百万的全栈工程师
- **对前后端都非常了解**
- **具有教学精神**，能够详细解释代码和技术原理

### 开发流程
1. **不擅自操作**：在执行任何操作前，先询问用户是否要执行
2. **过程详细**：每个步骤都要详细说明
3. **有教学感觉**：让用户能学会、学到知识
4. **循序渐进**：一步一步完成项目，不能跳过步骤

### 代码风格
- **保持一致性**：参考项目现有代码风格
- **注释清晰**：核心代码要有清晰的注释
- **命名规范**：使用清晰的变量和函数名
- **错误处理**：完善错误处理和用户提示

---

## 七、重要注意事项

### 1. Excel导入相关
- ✅ 使用"商品主图"列（不是"商品图片链接"列）
- ✅ 筛选条件：商品属性* === "M"
- ✅ 商品主图多个URL时，只取第一个

### 2. 功能隔离
- ✅ 标准模式：保留所有原有功能，包括轮播视频模式
- ✅ 拼图对齐模式：启用新功能，3:1强校验
- ✅ Excel导入：基础功能层，两种模式都可用

### 3. 数据流程
```
Excel导入 → 建立映射 → 扫描素材库打标签
素材上传 → 自动扫描映射表 → 打标签
拼图完成 → 外链同步 → 数据对齐 → 生成表格（阶段七已完成）→ 测试优化（阶段八）
```

### 4. 核心设计理念
- ✅ **以表单为准**：表单是主数据源，Store是辅助数据源
- ✅ **Store作为静态字典**：Store仅用于查找映射，不参与计数
- ✅ **实时解析**：校验和对齐都基于表单实时数据
- ✅ **位置敏感型解析**：补齐数组长度，使用位置索引

---

## 八、参考文档

### 方案文档
- `pinjie/广告投放新需求方案-最终完美版.md` - 完整技术方案
- `pinjie/数据对齐功能优化方案.md` - 对齐功能优化方案
- `pinjie/数据对齐逻辑问题分析.md` - 问题分析和解决方案

### 开发规范
- `cursor的对话风格` - 对话风格和角色定位
- `pinjie/开发风格和要求.md` - 开发风格要求

### 会话总结
- `pinjie/会话总结-2025-12-27-数据对齐优化.md` - 上次会话总结
- `pinjie/会话总结-2025-12-27-阶段七表格生成改造.md` - 本次会话总结

### 项目总结
- `项目开发总结-2025-12-27.md` - 项目开发总结（最新版本）

---

## 九、下一步工作

### 阶段八：测试和优化

**需要完成**：
1. 功能测试
2. 模式切换测试
3. 边界情况测试
4. 用户体验优化
5. 性能优化

**预计时间**：1-2小时

**开始方式**：
在新窗口中，告诉AI：
"请查看项目开发总结文件和会话总结文件，继续开发阶段八：测试和优化"

---

**最后更新**：2025年12月27日  
**文档版本**：v1.0


