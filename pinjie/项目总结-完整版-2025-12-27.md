# 广告投放新需求项目 - 完整总结

**最后更新**：2025年12月27日  
**项目状态**：已完成7/8阶段（87.5%），核心功能已完成  
**剩余工作**：阶段八 - 测试和优化

---

## 一、项目概述

### 1.1 项目目标

实现广告投放新需求技术方案，核心功能包括：
- ✅ Excel表格导入功能（筛选"商品属性*"为"M"的行）
- ✅ 图片拼接外链同步到广告投放页面
- ✅ 数据对应关系管理（外链 ↔ 图片链接 ↔ 商品ID/SPU）
- ✅ 智能对齐功能（按3:1规则生成表格）
- ✅ 双模式架构（标准模式 + 拼图对齐模式）

### 1.2 核心功能架构

```
┌─────────────────────────────────────┐
│  工作流模式切换（workflowMode）        │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────┐                │
│  │  标准模式        │                │
│  │  (standard)     │                │
│  │                 │                │
│  │  ✅ Excel导入    │ ← 基础功能层   │
│  │  ✅ 轮播视频模式   │                │
│  │  ✅ 1:1生成表格   │                │
│  └─────────────────┘                │
│                                     │
│  ┌─────────────────┐                │
│  │  拼图对齐模式    │                │
│  │  (stitch_sync)   │                │
│  │                 │                │
│  │  ✅ Excel导入    │ ← 基础功能层   │
│  │  ✅ 外链同步      │                │
│  │  ✅ 数据对齐      │                │
│  │  ✅ 3:1强校验    │                │
│  │  ✅ 3:1生成表格   │ ← 阶段七完成  │
│  └─────────────────┘                │
└─────────────────────────────────────┘
```

---

## 二、项目进度（7/8阶段，87.5%）

### ✅ 阶段一：基础工具和配置

**完成内容**：
- 安装依赖：`xlsx`、`pinia-plugin-persistedstate`
- 配置Pinia持久化插件
- 创建URL归一化工具函数

### ✅ 阶段二：Store结构设计

**完成内容**：
- 添加工作流模式状态（`workflowMode`）
- 添加数据映射关系（`productDataMapping`）
- 实现核心方法：模式切换、映射建立、数据对齐、校验等

### ✅ 阶段三：Excel导入功能

**完成内容**：
- Excel解析和表头识别
- 数据筛选（商品属性* === "M"）
- 建立映射关系和素材标签

### ✅ 阶段四：工作流模式UI

**完成内容**：
- 模式切换开关
- UI显示/隐藏逻辑

### ✅ 阶段五：图片拼接页面改造

**完成内容**：
- 外链同步功能
- 去重检查

### ✅ 阶段六：对齐功能

**完成内容**：
- 对齐预览表组件（支持折叠/展开）
- 实时监听文本框变化（防抖优化）
- 智能对齐逻辑（位置敏感型解析）
- 以表单为准的设计理念

### ✅ 阶段七：表格生成改造

**完成内容**：
- 校验拦截功能
- 3:1分组逻辑（拼图对齐模式）
- 1:1逻辑保持（标准模式）
- 后端支持拼图对齐模式的3:1分组数据
- **核心优化**：基于"实时解析"的校验机制，Store作为静态字典

### ✅ 阶段七优化：用户体验优化

**完成内容**：
- 模式切换时的数据清理提示
- 精准的错误提示（具体到行号和组号）
- 文件保存错误处理（InvalidStateError等）

### ⏳ 阶段八：测试和优化（待完成）

**待完成内容**：
- 功能测试（Excel导入、外链同步、数据对齐、表格生成）
- 模式切换测试
- 边界情况测试
- 用户体验优化
- 性能优化

---

## 三、核心技术点

### 3.1 URL归一化

**作用**：统一处理URL格式差异（去除参数、统一大小写等）  
**实现**：`frontend/src/utils/urlNormalize.js`

### 3.2 双向自动扫描机制

**原理**：
- Excel导入时：扫描素材库，为已有素材打标签
- 素材上传时：自动扫描商品映射表，为新素材打标签
- 效果：无论先做什么，都能自动匹配

### 3.3 位置敏感型解析（阶段六核心优化）

**技术原理**：
- 补齐数组长度到预期值（`formLinks.length * 3`）
- 不过滤空值，保留空行
- 使用位置索引（`startIndex + i`）获取数据，而不是 `slice`

**优势**：无论用户如何删除，位置索引永远正确，保持位置对应关系

### 3.4 以表单为准的设计理念（阶段六核心优化）

**核心思路**：
```
表单（文本框） → 主数据源（用于校验和计数）
Store（映射表） → 辅助数据源（用于查找和补全）
```

### 3.5 基于"实时解析"的校验机制（阶段七核心优化）

**技术原理**：
- 引入解析层函数 `getFormLinks`，实时解析表单文本框
- 校验完全基于表单实时数据，不依赖 Store
- Store 作为静态字典，仅用于查找映射，不参与计数

### 3.6 Store 作为静态字典的设计理念（阶段七核心优化）

**工作流程**：
1. 校验：基于表单实时解析数据
2. 对齐：以表单外链为准，去 Store 中查找对应的商品信息
3. 查找：查得到就用，查不到就留白或提示
4. 持久性：Store 映射保留，即使表单删除链接，重新粘贴后仍能找回

---

## 四、遇到的问题和解决方案

### 问题1：数组索引与位置不匹配（阶段六）

**问题描述**：
- 删除商品ID后，点击对齐只补充同一个（位置错乱）
- 删除SPU后，点击对齐没补回来（只检查ID）

**根本原因**：
- 使用 `slice` 获取数据，用户删除行后数组长度缩短，导致位置错乱
- 过滤空值破坏位置对应关系

**解决方法**：
- **位置敏感型解析**：补齐数组长度到预期值，使用位置索引获取数据
- **不过滤空值**：保留空行，保持位置对应关系
- **同时检查 ID 和 SPU**：如果其中一个为空，补全

### 问题2：对齐逻辑保留用户修改而不是对齐（阶段六）

**问题描述**：
- 点击"数据对齐"后，数据没有变化

**根本原因**：
- 逻辑错误：数据不匹配时，保留用户修改的数据，而不是用 Store 的数据替换

**解决方法**：
- 修改逻辑：数据不匹配时，用 Store 的数据替换，实现对齐

### 问题3：后端会拆分前端已分组的3:1数据（阶段七）

**问题描述**：
- 前端在拼图对齐模式下已经按3:1分组（ID/SPU用逗号连接）
- 后端仍然按逗号拆分，导致从3行变成9行

**根本原因**：
- 后端只检测 `轮播视频模式` 字段
- 拼图对齐模式下该字段为 false，导致后端再次拆分

**解决方法**：
- 修改后端 `processProductFields` 函数
- 检测商品ID/SPU是否包含逗号
- 如果包含逗号，即使不是轮播视频模式，也不拆分（作为单个值处理）

### 问题4：校验函数使用 Store 旧数据导致校验失败（阶段七）

**问题描述**：
- 用户手动删除表单中的外链后，Store 中的 `externalLinks` 数组没有同步更新
- 校验函数使用 Store 中的数据（旧数据），而表单中只有新数据
- 导致校验失败

**根本原因**：
- 校验函数 `validateStrictThree` 使用 `productDataMapping.value.externalLinks.length`
- Store 中的数据和表单中的数据不同步

**解决方法**（采用优化方案）：
1. 引入解析层函数 `getFormLinks`，实时解析表单中的外链数量
2. 修改 `validateStrictThree` 函数，完全基于表单文本框的实时解析数据
3. Store 仅作为映射字典，不参与计数

### 问题5：文件保存时的文件夹选择弹窗（阶段七优化）

**问题描述**：
- 生成表格后会弹出文件夹选择对话框，用户希望直接下载

**解决方法**：
- 移除 File System Access API 的文件夹选择功能
- 直接使用降级方案（浏览器自动下载到默认下载文件夹）

---

## 五、关键代码位置索引

### Store 方法（`frontend/src/stores/adCampaign.js`）

- `getFormLinks` - 第 333-355 行（解析层函数，实时解析表单外链）
- `validateStrictThree` - 第 357-420 行（三倍数校验，基于表单实时数据）
- `validateRowCountMatch` - 第 422-445 行（行数相等校验）
- `handleModeChange` - 模式切换（带确认对话框）
- `buildImageToProductMapping` - 建立映射关系
- `scanAndTagMaterials` - 扫描素材库并打标签
- `addExternalLink` - 添加外链（智能切换）

### 页面方法（`frontend/src/views/AdCampaign.vue`）

- `handleModeChange` - 第 2118-2124 行（模式切换处理）
- `handleExcelImport` - Excel导入处理
- `handleAlignData` - 第 2040-2285 行（智能对齐方法）
- `alignmentStatus` - 第 2325-2576 行（对齐状态计算属性）
- `generateAllTables` - 第 1870-1905 行（校验拦截），第 1950-2037 行（生成逻辑）
- `processBatchInput` - 第 948-1110 行（数据分组逻辑，3:1分组）
- `downloadFile` - 第 1758-1828 行（文件下载，带错误处理）
- `saveTablesToFolder` - 第 1850-1856 行（保存表格，直接下载）

### 后端方法（`api-gateway/server.js`）

- `processProductFields` - 第 745-810 行（处理商品字段，支持拼图对齐模式的3:1分组）

---

## 六、开发风格和角色定位

### 角色定位
- **AI 助手角色**：一个有十年全栈经验的全栈工程师
- **具有教学精神**，能够详细解释代码和技术原理

### 开发风格要求

1. **教学式开发**
   - 详细解释每个步骤的代码作用和原理
   - 解释相关的技术概念和最佳实践
   - 核心代码要有清晰的注释

2. **开发流程**
   - **不擅自操作**：在执行任何操作前，先询问用户是否要执行
   - 过程详细：每个步骤都要详细说明
   - 有教学感觉：让用户能学会、学到知识
   - 循序渐进：一步一步完成项目，不能跳过步骤

3. **代码风格**
   - 保持一致性：参考项目现有代码风格
   - 注释清晰：核心代码要有注释说明
   - 命名规范：使用清晰的变量和函数名
   - 错误处理：完善错误处理和用户提示

---

## 七、测试状态

### ✅ 已验证功能

#### 阶段七验证
- [x] 校验拦截功能正常（validateRowCountMatch + validateStrictThree）
- [x] 3:1分组逻辑正常（拼图对齐模式）
- [x] 1:1逻辑保持正常（标准模式）
- [x] 后端支持拼图对齐模式的3:1分组数据（不拆分包含逗号的ID/SPU）
- [x] 校验函数基于表单实时数据（解决数据同步不一致问题）
- [x] 模式切换提示正常（有映射数据时弹出确认对话框）
- [x] 错误提示精准（具体到行号和组号）
- [x] 文件保存错误处理正常（InvalidStateError等）

### 📋 测试用例文档

详细测试用例请参考：`TEST_CASES.md`（项目根目录）

---

## 八、项目文件结构

### 主要修改的文件

1. **`frontend/src/main.js`**
   - 配置 Pinia 持久化插件

2. **`frontend/src/utils/urlNormalize.js`**（新建）
   - URL 归一化工具函数

3. **`frontend/src/stores/adCampaign.js`**
   - 添加工作流模式、数据映射、核心方法

4. **`frontend/src/stores/imageStitch.js`**
   - 增强 `addMaterial` 方法
   - 增强槽位记录功能

5. **`frontend/src/views/AdCampaign.vue`**
   - 添加模式切换开关
   - 添加 Excel 导入功能
   - 添加对齐按钮和对齐预览表组件
   - 实现实时监听文本框变化（防抖优化）
   - 重写对齐状态检测（以表单为准）
   - 重写智能对齐逻辑（位置敏感型解析）
   - 表格生成改造：校验拦截、3:1分组逻辑
   - 用户体验优化：模式切换提示、精准错误提示、文件保存错误处理

6. **`frontend/src/views/ImageStitch.vue`**
   - 增强 `handleDrop` 方法
   - 添加外链同步功能

7. **`api-gateway/server.js`**
   - 修改 `processProductFields` 函数，支持拼图对齐模式的3:1分组数据

---

## 九、重要注意事项

### 1. Excel导入相关
- ✅ 使用"商品主图"列（不是"商品图片链接"列）
- ✅ 筛选条件：商品属性* === "M"
- ✅ 商品主图多个URL时，只取第一个

### 2. 功能隔离
- ✅ 标准模式：保留所有原有功能，包括轮播视频模式
- ✅ 拼图对齐模式：启用新功能，3:1强校验
- ✅ Excel导入：基础功能层，两种模式都可用

### 3. 数据流程
```
Excel导入 → 建立映射 → 扫描素材库打标签
素材上传 → 自动扫描映射表 → 打标签
拼图完成 → 外链同步 → 数据对齐 → 生成表格 → 直接下载
```

### 4. 核心设计理念
- ✅ **以表单为准**：表单是主数据源，Store是辅助数据源
- ✅ **Store作为静态字典**：Store仅用于查找映射，不参与计数
- ✅ **实时解析**：校验和对齐都基于表单实时数据
- ✅ **位置敏感型解析**：补齐数组长度，使用位置索引

---

## 十、下一步计划

### 阶段八：测试和优化

**待完成内容**：
1. 功能测试
   - Excel导入、外链同步、数据对齐、表格生成
   - 拼图对齐模式3:1分组逻辑完整流程测试
   - 标准模式1:1逻辑保持正常测试

2. 模式切换测试
   - 标准模式和拼图对齐模式的切换
   - 确保功能隔离

3. 边界情况测试
   - 空数据、数据不匹配、URL格式差异
   - 用户删除外链后重新同步的场景

4. 用户体验优化
   - 提示信息、错误处理、加载状态

5. 性能优化
   - 大量数据时的性能考虑

---

## 十一、参考文档

### 核心文档
- `pinjie/广告投放新需求方案-最终完美版.md` - 完整技术方案
- `TEST_CASES.md` - 测试用例文档（项目根目录）

### 开发规范
- `cursor的对话风格` - 对话风格和角色定位
- `pinjie/开发风格和要求.md` - 开发风格要求

---

**最后更新**：2025年12月27日  
**文档版本**：v1.0  
**项目状态**：核心功能已完成，待测试和优化


