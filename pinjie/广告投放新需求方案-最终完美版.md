# å¹¿å‘ŠæŠ•æ”¾æ–°éœ€æ±‚æŠ€æœ¯æ–¹æ¡ˆï¼ˆæœ€ç»ˆå®Œç¾ç‰ˆï¼‰

## ä¸€ã€éœ€æ±‚æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½
- **Excelè¡¨æ ¼å¯¼å…¥**ï¼šå¯¼å…¥å•†å“æ•°æ®ï¼Œç­›é€‰"å•†å“å±æ€§*"ä¸º"M"çš„è¡Œ
- **å›¾ç‰‡æ‹¼æ¥å¤–é“¾åŒæ­¥**ï¼šä»æ‹¼å›¾é¡µé¢åŒæ­¥å¤–é“¾åˆ°å¹¿å‘ŠæŠ•æ”¾é¡µé¢
- **æ•°æ®å¯¹åº”å…³ç³»ç®¡ç†**ï¼šç»´æŠ¤å¤–é“¾ â†” å›¾ç‰‡é“¾æ¥ â†” å•†å“ID/SPUçš„æ˜ å°„
- **æ™ºèƒ½å¯¹é½åŠŸèƒ½**ï¼šè‡ªåŠ¨å¯¹é½å•†å“æ•°æ®ä¸å¤–é“¾ï¼ŒæŒ‰3:1è§„åˆ™ç”Ÿæˆè¡¨æ ¼

### 1.2 å·¥ä½œæµæ¨¡å¼
- **æ ‡å‡†æ¨¡å¼**ï¼šä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œè‡ªç”±å¡«å†™ï¼Œ1:1ç”Ÿæˆè¡¨æ ¼
- **æ‹¼å›¾å¯¹é½æ¨¡å¼**ï¼šæ–°åŠŸèƒ½ï¼ŒExcelå¯¼å…¥ + å¤–é“¾åŒæ­¥ + 3:1å¼ºæ ¡éªŒ

---

## äºŒã€æ ¸å¿ƒä¼˜åŒ–ç‚¹ï¼ˆå®Œå…¨é‡‡çº³ï¼‰

### 2.1 URLå½’ä¸€åŒ–å¤„ç† âœ…

**å®ç°**ï¼šæ‰€æœ‰å›¾ç‰‡é“¾æ¥åŒ¹é…æ—¶ç»Ÿä¸€ä½¿ç”¨å½’ä¸€åŒ–å‡½æ•°ã€‚

```javascript
/**
 * URLå½’ä¸€åŒ–å‡½æ•°
 */
export const normalizeUrl = (url) => {
  if (!url || typeof url !== 'string') return ''
  
  try {
    const trimmedUrl = url.trim()
    if (!trimmedUrl) return ''
    
    const u = new URL(trimmedUrl)
    return (u.origin + u.pathname).toLowerCase()
  } catch (e) {
    return trimmedUrl.split('?')[0].split('#')[0].toLowerCase().trim()
  }
}
```

---

### 2.2 çŠ¶æ€æŒä¹…åŒ– âœ…

**å®ç°**ï¼šä½¿ç”¨ `pinia-plugin-persistedstate` å®ç°æ•°æ®æŒä¹…åŒ–ã€‚

```javascript
// stores/adCampaign.js
export const useAdCampaignStore = defineStore('adCampaign', () => {
  // ... çŠ¶æ€å®šä¹‰ ...
}, {
  persist: {
    key: 'ad-campaign-data',
    storage: window.localStorage,
    paths: ['productDataMapping', 'workflowMode', 'syncSource']
  }
})
```

---

### 2.3 å·¥ä½œæµæ¨¡å¼åˆ‡æ¢ âœ… **æ–°å¢æ ¸å¿ƒåŠŸèƒ½**

**è®¾è®¡**ï¼šåœ¨é¡µé¢é¡¶éƒ¨æ·»åŠ æ¨¡å¼åˆ‡æ¢å¼€å…³ã€‚

```vue
<template>
  <div class="workflow-header">
    <el-radio-group v-model="workflowMode" size="large" @change="handleModeChange">
      <el-radio-button label="standard">æ ‡å‡†æ¨¡å¼</el-radio-button>
      <el-radio-button label="stitch_sync">æ‹¼å›¾å¯¹é½æ¨¡å¼ (3:1)</el-radio-button>
    </el-radio-group>
    <el-tooltip content="æ ‡å‡†æ¨¡å¼ï¼šè‡ªç”±å¡«å†™ï¼Œ1:1ç”Ÿæˆè¡¨æ ¼ã€‚æ‹¼å›¾å¯¹é½æ¨¡å¼ï¼šExcelå¯¼å…¥+å¤–é“¾åŒæ­¥ï¼Œ3:1å¼ºæ ¡éªŒ">
      <el-icon><QuestionFilled /></el-icon>
    </el-tooltip>
  </div>
</template>
```

**é€»è¾‘**ï¼š
- **æ ‡å‡†æ¨¡å¼**ï¼šä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œä¸è¿›è¡Œ3:1æ ¡éªŒ
- **æ‹¼å›¾å¯¹é½æ¨¡å¼**ï¼šæ¿€æ´»Excelå¯¼å…¥ã€å¯¹é½æŒ‰é’®ã€3:1å¼ºæ ¡éªŒã€æ¥æ”¶æ‹¼å›¾åŒæ­¥

---

### 2.4 åŒæ­¥æ¨¡å¼çš„æ™ºèƒ½åˆ‡æ¢ âœ… **æ–°å¢æ ¸å¿ƒä¼˜åŒ–**

**é—®é¢˜**ï¼šé¦–æ¬¡åŒæ­¥éœ€è¦è¦†ç›–Excelå¯¼å…¥çš„æ—§é“¾æ¥ï¼Œåç»­è¿½åŠ ã€‚

**å®ç°**ï¼šåœ¨Storeä¸­æ·»åŠ  `syncSource` çŠ¶æ€ï¼Œæ™ºèƒ½åˆ¤æ–­ã€‚

```javascript
// stores/adCampaign.js
const syncSource = ref('none') // 'none' | 'excel' | 'stitch'

// æ·»åŠ å¤–é“¾çš„æ–¹æ³•ï¼ˆæ™ºèƒ½åˆ‡æ¢ï¼‰
const addExternalLink = (externalLink, imageLinks) => {
  const normalizedExternalLink = normalizeUrl(externalLink)
  
  // å»é‡æ£€æŸ¥
  const existing = productDataMapping.value.externalLinks.find(
    item => normalizeUrl(item.externalLink) === normalizedExternalLink
  )
  if (existing) {
    ElMessage.warning('è¯¥å¤–é“¾å·²åŒæ­¥è¿‡ï¼Œä¸å†é‡å¤è¿½åŠ ')
    return
  }
  
  // æ™ºèƒ½åˆ‡æ¢é€»è¾‘
  const isFirstStitchSync = syncSource.value === 'excel' || 
                           (syncSource.value === 'none' && productDataMapping.value.externalLinks.length === 0)
  
  if (isFirstStitchSync && syncSource.value === 'excel') {
    // é¦–æ¬¡ä»æ‹¼å›¾åŒæ­¥ï¼Œä¸”ä¹‹å‰æœ‰Excelæ•°æ®ï¼šè¦†ç›–æ¨¡å¼
    productDataMapping.value.externalLinks = [{
      externalLink,
      imageLinks: imageLinks.map(item => normalizeUrl(item.link))
    }]
    // æ¸…ç©ºè¡¨å•ä¸­çš„å•†å“å›¾ç‰‡é“¾æ¥å­—æ®µï¼ˆè¦†ç›–ï¼‰
    formData['å•†å“å›¾ç‰‡é“¾æ¥'] = externalLink
    ElMessage.info('é¦–æ¬¡åŒæ­¥å¤–é“¾ï¼Œå·²è¦†ç›–Excelå¯¼å…¥çš„å›¾ç‰‡é“¾æ¥')
  } else {
    // è¿½åŠ æ¨¡å¼
    productDataMapping.value.externalLinks.push({
      externalLink,
      imageLinks: imageLinks.map(item => normalizeUrl(item.link))
    })
    // è¿½åŠ åˆ°è¡¨å•
    const existingLinks = formData['å•†å“å›¾ç‰‡é“¾æ¥'] ? formData['å•†å“å›¾ç‰‡é“¾æ¥'].split('\n').filter(l => l.trim()) : []
    existingLinks.push(externalLink)
    formData['å•†å“å›¾ç‰‡é“¾æ¥'] = existingLinks.join('\n')
  }
  
  // æ›´æ–°åŒæ­¥æ¥æºæ ‡è®°
  syncSource.value = 'stitch'
  
  // æ›´æ–°æ˜ å°„å…³ç³»
  updateImageLinkMapping()
}
```

---

### 2.5 ç´ æåº“ä¸å•†å“æ•°æ®çš„æ·±åº¦ç»‘å®š âœ… **æ–°å¢æ ¸å¿ƒä¼˜åŒ–ï¼ˆå¢å¼ºç‰ˆï¼‰**

**é—®é¢˜**ï¼šå¦‚æœåªé URLå­—ç¬¦ä¸²åŒ¹é…ï¼Œæ•ˆç‡ä½ä¸”å®¹æ˜“å‡ºé”™ã€‚è€Œä¸”å­˜åœ¨æ—¶åºé—®é¢˜ï¼šç”¨æˆ·å¯èƒ½å…ˆå¯¼å…¥Excelï¼Œä¹Ÿå¯èƒ½å…ˆä¸Šä¼ ç´ æã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼šåŒå‘è‡ªåŠ¨æ‰«ææœºåˆ¶

#### 2.5.1 Excelå¯¼å…¥æ—¶æ‰«æç´ æåº“ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰

```javascript
// stores/adCampaign.js

/**
 * Excelå¯¼å…¥æˆåŠŸåï¼Œæ‰«æç´ æåº“å¹¶æ‰“æ ‡ç­¾
 */
const scanAndTagMaterials = (productIds, productSpus, productImages) => {
  const imageStitchStore = useImageStitchStore()
  
  productImages.forEach((imageUrl, index) => {
    const normalizedUrl = normalizeUrl(imageUrl)
    const productId = productIds[index]
    const productSpu = productSpus[index]
    
    // åœ¨ç´ æåº“ä¸­æŸ¥æ‰¾åŒ¹é…çš„ç´ æ
    const matchedMaterial = imageStitchStore.materials.find(material => {
      const materialUrl = normalizeUrl(material.originalUrl || material.publicUrl || '')
      return materialUrl === normalizedUrl
    })
    
    if (matchedMaterial) {
      // ç»™ç´ ææ‰“ä¸Šå•†å“ä¿¡æ¯æ ‡ç­¾
      matchedMaterial.productInfo = {
        productId,
        productSpu,
        productImage: imageUrl
      }
      console.log(`âœ… [Store] ç´ æå·²æ ‡è®°å•†å“ä¿¡æ¯: ${matchedMaterial.id} -> ${productId}/${productSpu}`)
    }
  })
}
```

#### 2.5.2 ç´ æä¸Šä¼ æ—¶è‡ªåŠ¨é‡æ‰«æï¼ˆæ–°å¢ä¼˜åŒ–ï¼‰âœ…

**åœºæ™¯**ï¼šç”¨æˆ·å…ˆå¯¼å…¥äº†Excelï¼Œç„¶åæ‰å»ä¸Šä¼ æ–°çš„ç´ æå›¾ç‰‡ã€‚

**å®ç°**ï¼šåœ¨`imageStitchStore`çš„`addMaterial`æ–¹æ³•ä¸­æ·»åŠ é’©å­ã€‚

```javascript
// stores/imageStitch.js

import { defineStore } from 'pinia'
import { normalizeUrl } from '@/utils/urlNormalize'

export const useImageStitchStore = defineStore('imageStitch', () => {
  // ... åŸæœ‰çŠ¶æ€å’Œæ–¹æ³• ...
  
  /**
   * æ–¹æ³•ï¼šæ·»åŠ ç´ æåˆ°åˆ—è¡¨ï¼ˆå¢å¼ºç‰ˆ - è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯ï¼‰
   * @param {Object} material - ç´ æå¯¹è±¡
   */
  const addMaterial = (material) => {
    // 1. æ·»åŠ åˆ°ç´ æåˆ—è¡¨ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
    materials.value.push(material)
    console.log('ğŸ“¦ [Store] æ·»åŠ ç´ æ:', material.id)
    
    // 2. è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯ï¼ˆæ–°å¢é€»è¾‘ï¼‰
    autoScanProductInfo(material)
  }
  
  /**
   * è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯ï¼ˆæ–°å¢æ–¹æ³•ï¼‰
   * å½“æ–°ç´ æä¸Šä¼ æ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥adCampaignStoreçš„æ˜ å°„è¡¨ï¼Œå¦‚æœåŒ¹é…å°±è‡ªåŠ¨æ‰“æ ‡ç­¾
   */
  const autoScanProductInfo = (material) => {
    try {
      // åŠ¨æ€å¯¼å…¥adCampaignStoreï¼ˆé¿å…å¾ªç¯ä¾èµ–ï¼‰
      const { useAdCampaignStore } = await import('./adCampaign')
      const adCampaignStore = useAdCampaignStore()
      
      // è·å–ç´ æçš„URLï¼ˆå°è¯•å¤šä¸ªå¯èƒ½çš„å­—æ®µï¼‰
      const materialUrl = material.originalUrl || material.publicUrl || material.previewUrl || ''
      if (!materialUrl) {
        return // æ²¡æœ‰URLï¼Œæ— æ³•åŒ¹é…
      }
      
      // å½’ä¸€åŒ–URL
      const normalizedUrl = normalizeUrl(materialUrl)
      if (!normalizedUrl) {
        return
      }
      
      // åœ¨adCampaignStoreçš„æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾
      const imageToProduct = adCampaignStore.productDataMapping?.imageToProduct || {}
      const productInfo = imageToProduct[normalizedUrl]
      
      if (productInfo) {
        // æ‰¾åˆ°åŒ¹é…çš„å•†å“ä¿¡æ¯ï¼Œè‡ªåŠ¨æ‰“æ ‡ç­¾
        material.productInfo = {
          productId: productInfo.productId,
          productSpu: productInfo.productSpu,
          productImage: materialUrl
        }
        console.log(`âœ… [ImageStitch Store] ç´ æè‡ªåŠ¨æ ‡è®°å•†å“ä¿¡æ¯: ${material.id} -> ${productInfo.productId}/${productInfo.productSpu}`)
        
        // å¯é€‰ï¼šæ˜¾ç¤ºæç¤ºï¼ˆé¿å…è¿‡äºé¢‘ç¹çš„æç¤ºï¼‰
        // ElMessage.success(`ç´ æå·²è‡ªåŠ¨å…³è”å•†å“: ${productInfo.productId}`)
      } else {
        console.log(`â„¹ï¸ [ImageStitch Store] ç´ ææœªæ‰¾åˆ°åŒ¹é…çš„å•†å“ä¿¡æ¯: ${material.id}`)
      }
    } catch (error) {
      // å¦‚æœadCampaignStoreä¸å­˜åœ¨æˆ–æœªåˆå§‹åŒ–ï¼Œé™é»˜å¤±è´¥ï¼ˆä¸å½±å“ç´ ææ·»åŠ ï¼‰
      console.warn('âš ï¸ [ImageStitch Store] è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯å¤±è´¥ï¼ˆå¯èƒ½adCampaignStoreæœªåˆå§‹åŒ–ï¼‰:', error)
    }
  }
  
  return {
    // ... åŸæœ‰è¿”å›å€¼ ...
    addMaterial // ä½¿ç”¨å¢å¼ºç‰ˆçš„addMaterial
  }
})
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- âœ… æ— è®ºå…ˆå¯¼å…¥Excelè¿˜æ˜¯å…ˆä¸Šä¼ ç´ æï¼Œéƒ½èƒ½è‡ªåŠ¨åŒ¹é…
- âœ… å®æ—¶æ€§ï¼šæ–°ç´ æä¸Šä¼ åç«‹å³æ£€æŸ¥å¹¶æ‰“æ ‡ç­¾
- âœ… æ— éœ€æ‰‹åŠ¨æ“ä½œï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½

#### 2.5.3 æ‰¹é‡ä¸Šä¼ æ—¶çš„ä¼˜åŒ–

å¦‚æœç”¨æˆ·æ‰¹é‡ä¸Šä¼ å¤šä¸ªç´ æï¼Œå¯ä»¥ä¼˜åŒ–ä¸ºæ‰¹é‡æ‰«æï¼š

```javascript
/**
 * æ‰¹é‡æ·»åŠ ç´ æï¼ˆå¢å¼ºç‰ˆï¼‰
 */
const addMaterials = (materialsArray) => {
  materialsArray.forEach(material => {
    materials.value.push(material)
    // å¼‚æ­¥æ‰«æï¼Œä¸é˜»å¡ä¸»æµç¨‹
    setTimeout(() => {
      autoScanProductInfo(material)
    }, 0)
  })
  
  console.log(`ğŸ“¦ [Store] æ‰¹é‡æ·»åŠ  ${materialsArray.length} ä¸ªç´ æ`)
}
```

---

### 2.6 ä¸¥æ ¼çš„ä¸‰å€æ•°å¼ºæ ¡éªŒ âœ… **æ–°å¢æ ¸å¿ƒçº¦æŸ**

**å®ç°**ï¼šåœ¨æ‰§è¡Œå¯¹é½å’Œç”Ÿæˆè¡¨æ ¼å‰è¿›è¡Œå¼ºåˆ¶æ ¡éªŒã€‚

```javascript
// stores/adCampaign.js

/**
 * ä¸¥æ ¼çš„ä¸‰å€æ•°æ ¡éªŒï¼ˆä»…æ‹¼å›¾å¯¹é½æ¨¡å¼ï¼‰
 */
const validateStrictThree = () => {
  // åªåœ¨æ‹¼å›¾å¯¹é½æ¨¡å¼ä¸‹æ ¡éªŒ
  if (workflowMode.value !== 'stitch_sync') {
    return true
  }
  
  const externalLinks = productDataMapping.value.externalLinks || []
  const externalLinkCount = externalLinks.length
  
  // ä»è¡¨å•ä¸­è·å–å•†å“IDæ•°é‡
  const productIds = formData['å•†å“ID'] ? 
    formData['å•†å“ID'].split('\n').filter(id => id.trim()) : []
  const idCount = productIds.length
  
  // å¼ºæ ¡éªŒï¼šå¿…é¡»æ˜¯3çš„å€æ•°
  if (externalLinkCount === 0) {
    ElMessage.warning('è¯·å…ˆåŒæ­¥å¤–é“¾')
    return false
  }
  
  const requiredIdCount = externalLinkCount * 3
  
  if (idCount !== requiredIdCount) {
    ElMessageBox.alert(
      `æ•°æ®ä¸åŒ¹é…ï¼\n\n` +
      `å½“å‰æœ‰ ${externalLinkCount} ä¸ªå¤–é“¾ï¼Œéœ€è¦ ${requiredIdCount} ä¸ªå•†å“ä¿¡æ¯ã€‚\n` +
      `ä½†å®é™…æ£€æµ‹åˆ° ${idCount} ä¸ªå•†å“IDã€‚\n\n` +
      `è¯·æ£€æŸ¥ï¼š\n` +
      `1. æ˜¯å¦æœ‰æ‹¼å›¾æœªå®Œæˆï¼ˆæ¯ä¸ªæ‹¼å›¾éœ€è¦3å¼ å›¾ç‰‡ï¼‰\n` +
      `2. Excelæ•°æ®æ˜¯å¦æœ‰é—æ¼\n` +
      `3. æ•°æ®å¯¹é½æ˜¯å¦æ­£ç¡®`,
      'æ ¡éªŒå¤±è´¥',
      { type: 'error', confirmButtonText: 'çŸ¥é“äº†' }
    )
    return false
  }
  
  return true
}

/**
 * è¡Œæ•°ç›¸ç­‰æ ¡éªŒï¼ˆæ‰€æœ‰æ¨¡å¼é€šç”¨ï¼‰
 */
const validateRowCountMatch = () => {
  const productIds = formData['å•†å“ID'] ? 
    formData['å•†å“ID'].split('\n').filter(id => id.trim()) : []
  const productSpus = formData['å•†å“SPU'] ? 
    formData['å•†å“SPU'].split('\n').filter(spu => spu.trim()) : []
  
  if (productIds.length !== productSpus.length) {
    ElMessageBox.alert(
      `æ•°æ®ä¸ä¸€è‡´ï¼\n\n` +
      `å•†å“IDæœ‰ ${productIds.length} è¡Œ\n` +
      `å•†å“SPUæœ‰ ${productSpus.length} è¡Œ\n\n` +
      `è¯·ç¡®ä¿å•†å“IDå’Œå•†å“SPUçš„è¡Œæ•°ä¸€è‡´ï¼Œä¸”ä¸€ä¸€å¯¹åº”ã€‚`,
      'æ•°æ®æ ¡éªŒå¤±è´¥',
      { type: 'warning', confirmButtonText: 'çŸ¥é“äº†' }
    )
    return false
  }
  
  return true
}
```

---

### 2.7 é¢„è§ˆåŒºåŸŸçš„æ•°æ®å¯¹é½é¢„è§ˆè¡¨ âœ… **æ–°å¢å¯è§†åŒ–ä¼˜åŒ–**

**å®ç°**ï¼šå¯è§†åŒ–æ˜¾ç¤ºå¯¹é½çŠ¶æ€ã€‚

```vue
<template>
  <div class="alignment-preview" v-if="workflowMode === 'stitch_sync' && alignmentStatus">
    <div class="preview-header">
      <h4>æ•°æ®å¯¹é½é¢„è§ˆ</h4>
      <el-tag :type="alignmentStatus.allAligned ? 'success' : 'warning'">
        {{ alignmentStatus.allAligned ? 'å·²å¯¹é½' : 'éƒ¨åˆ†å¯¹é½' }}
      </el-tag>
    </div>
    
    <div class="preview-list">
      <div 
        v-for="(group, index) in alignmentStatus.groups" 
        :key="index"
        class="preview-item"
        :class="{ 'item-complete': group.complete, 'item-incomplete': !group.complete }"
      >
        <div class="item-header">
          <span class="item-index">å¤–é“¾ {{ index + 1 }}</span>
          <el-tag size="small" :type="group.complete ? 'success' : 'danger'">
            {{ group.matched }}/3
          </el-tag>
        </div>
        
        <div class="item-content">
          <div class="link-preview">{{ group.externalLink }}</div>
          <div class="products-preview">
            <div 
              v-for="(product, pIndex) in group.products" 
              :key="pIndex"
              class="product-box"
              :class="{ 
                'product-matched': product.matched,
                'product-unmatched': !product.matched
              }"
            >
              <div class="product-spu">{{ product.spu || 'æœªåŒ¹é…' }}</div>
              <div class="product-id">{{ product.id || '-' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="preview-summary">
      <div class="summary-item">
        <span>æ€»è®¡:</span>
        <strong>{{ alignmentStatus.totalGroups }} ç»„</strong>
      </div>
      <div class="summary-item">
        <span>å·²å¯¹é½:</span>
        <strong style="color: #67c23a;">{{ alignmentStatus.alignedCount }} ç»„</strong>
      </div>
      <div class="summary-item" v-if="alignmentStatus.incompleteCount > 0">
        <span>ä¸å®Œæ•´:</span>
        <strong style="color: #e6a23c;">{{ alignmentStatus.incompleteCount }} ç»„</strong>
      </div>
      <div class="summary-item" v-if="alignmentStatus.unmatchedCount > 0">
        <span>æœªåŒ¹é…å›¾ç‰‡:</span>
        <strong style="color: #f56c6c;">{{ alignmentStatus.unmatchedCount }} ä¸ª</strong>
      </div>
    </div>
  </div>
</template>

<script setup>
const alignmentStatus = computed(() => {
  if (workflowMode.value !== 'stitch_sync') return null
  
  const externalLinks = productDataMapping.value.externalLinks || []
  const imageToProduct = productDataMapping.value.imageToProduct || {}
  
  const groups = externalLinks.map((linkRecord) => {
    const { externalLink, imageLinks, productInfo } = linkRecord
    
    // ä¼˜å…ˆä½¿ç”¨productInfo
    let products = []
    if (productInfo && productInfo.length > 0) {
      products = productInfo.map(info => ({
        matched: true,
        id: info.productId,
        spu: info.productSpu
      }))
    } else {
      products = imageLinks.map(imageLink => {
        const normalizedLink = normalizeUrl(imageLink)
        const product = imageToProduct[normalizedLink]
        return {
          imageLink,
          matched: !!product,
          id: product?.productId || null,
          spu: product?.productSpu || null
        }
      })
    }
    
    const matchedCount = products.filter(p => p.matched).length
    const complete = matchedCount === 3
    
    return {
      externalLink,
      products,
      matched: matchedCount,
      complete
    }
  })
  
  const alignedCount = groups.filter(g => g.complete).length
  const incompleteCount = groups.filter(g => !g.complete && g.matched > 0).length
  const unmatchedCount = groups.reduce((sum, g) => {
    return sum + g.products.filter(p => !p.matched).length
  }, 0)
  
  return {
    totalGroups: groups.length,
    alignedCount,
    incompleteCount,
    unmatchedCount,
    allAligned: alignedCount === groups.length && groups.length > 0,
    groups
  }
})
</script>

<style scoped>
.alignment-preview {
  margin-top: 20px;
  padding: 16px;
  background-color: #f5f7fa;
  border-radius: 8px;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.preview-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.preview-item {
  padding: 12px;
  background: white;
  border-radius: 4px;
  border: 2px solid #e4e7ed;
}

.preview-item.item-complete {
  border-color: #67c23a;
}

.preview-item.item-incomplete {
  border-color: #e6a23c;
}

.item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.item-index {
  font-weight: 600;
}

.link-preview {
  font-size: 12px;
  color: #909399;
  margin-bottom: 8px;
  word-break: break-all;
}

.products-preview {
  display: flex;
  gap: 8px;
}

.product-box {
  flex: 1;
  padding: 8px;
  border-radius: 4px;
  text-align: center;
  border: 1px solid #e4e7ed;
}

.product-box.product-matched {
  background-color: #f0f9ff;
  border-color: #67c23a;
}

.product-box.product-unmatched {
  background-color: #fef0f0;
  border-color: #f56c6c;
}

.product-spu {
  font-weight: 600;
  margin-bottom: 4px;
}

.product-id {
  font-size: 11px;
  color: #909399;
}

.preview-summary {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #e4e7ed;
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}

.summary-item {
  font-size: 14px;
}
</style>
```

---

### 2.8 Excelå¯¼å…¥çš„æ™ºèƒ½æ˜ å°„ä¸é¢„è§ˆ âœ…

**å®ç°**ï¼šè‡ªåŠ¨è¯†åˆ« + æ‰‹åŠ¨æ˜ å°„ + é¢„è§ˆç¡®è®¤ã€‚

```javascript
// Excelå¯¼å…¥å¤„ç†
const processExcelImport = (file) => {
  // 1. è§£æExcel
  parseExcelFile(file).then(jsonData => {
    // 2. è‡ªåŠ¨è¯†åˆ«è¡¨å¤´
    const headers = autoDetectHeaders(jsonData[0] || {})
    
    // 3. æ£€æŸ¥å¿…éœ€è¡¨å¤´
    const missingHeaders = checkRequiredHeaders(headers)
    
    if (missingHeaders.length > 0) {
      // 4. æ‰‹åŠ¨æ˜ å°„
      showManualMappingDialog(jsonData[0], missingHeaders).then(manualHeaders => {
        if (manualHeaders) {
          const finalHeaders = { ...headers, ...manualHeaders }
          processExcelDataWithHeaders(jsonData, finalHeaders)
        }
      })
    } else {
      // 5. ç›´æ¥å¤„ç†ï¼ˆä½†å…ˆé¢„è§ˆï¼‰
      processExcelDataWithHeaders(jsonData, headers)
    }
  })
}

const processExcelDataWithHeaders = (jsonData, headers) => {
  // ç­›é€‰"M"å±æ€§
  const filteredData = jsonData.filter(row => {
    const attrValue = String(row[headers.productAttribute] || '').trim().toUpperCase()
    return attrValue === 'M'
  })
  
  // æå–æ•°æ®
  const extractedData = {
    productIds: [],
    productSpus: [],
    productImages: []
  }
  
  filteredData.forEach(row => {
    const id = String(row[headers.productId] || '').trim()
    const spu = String(row[headers.productSpu] || '').trim()
    const image = String(row[headers.productImage] || '').trim()
    
    if (id && spu && image) {
      extractedData.productIds.push(id)
      extractedData.productSpus.push(spu)
      extractedData.productImages.push(normalizeUrl(image)) // å½’ä¸€åŒ–
    }
  })
  
  // è¡Œæ•°ä¸€è‡´æ€§æ£€æŸ¥
  if (extractedData.productIds.length !== extractedData.productSpus.length ||
      extractedData.productIds.length !== extractedData.productImages.length) {
    ElMessage.error('æå–çš„æ•°æ®è¡Œæ•°ä¸ä¸€è‡´ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶')
    return
  }
  
  // é¢„è§ˆç¡®è®¤
  showImportPreviewDialog(extractedData).then(confirmed => {
    if (confirmed) {
      // ç¡®è®¤åå¡«å……è¡¨å•
      formData['å•†å“ID'] = extractedData.productIds.join('\n')
      formData['å•†å“SPU'] = extractedData.productSpus.join('\n')
      // æ³¨æ„ï¼šè¿™é‡Œå­˜å‚¨åŸå§‹URLï¼Œæ˜¾ç¤ºæ—¶ç”¨åŸå§‹URL
      const originalImages = filteredData.map(row => String(row[headers.productImage] || '').trim())
      formData['å•†å“å›¾ç‰‡é“¾æ¥'] = originalImages.join('\n')
      
      // å»ºç«‹æ˜ å°„ï¼ˆä½¿ç”¨å½’ä¸€åŒ–URLï¼‰
      buildImageToProductMapping(
        extractedData.productIds,
        extractedData.productSpus,
        extractedData.productImages
      )
      
      // æ‰«æç´ æåº“å¹¶æ‰“æ ‡ç­¾ï¼ˆä½¿ç”¨åŸå§‹URLè¿›è¡ŒåŒ¹é…ï¼‰
      scanAndTagMaterials(
        extractedData.productIds,
        extractedData.productSpus,
        originalImages
      )
      
      // æ ‡è®°åŒæ­¥æ¥æº
      syncSource.value = 'excel'
      
      ElMessage.success(`æˆåŠŸå¯¼å…¥ ${extractedData.productIds.length} æ¡æ•°æ®`)
    }
  })
}
```

---

### 2.9 å¤–é“¾åŒæ­¥å»é‡ âœ…

**å®ç°**ï¼šæ£€æŸ¥å¤–é“¾æ˜¯å¦å·²å­˜åœ¨ã€‚

```javascript
const addExternalLink = (externalLink, imageLinks) => {
  const normalizedExternalLink = normalizeUrl(externalLink)
  
  // å»é‡æ£€æŸ¥
  const existing = productDataMapping.value.externalLinks.find(
    item => normalizeUrl(item.externalLink) === normalizedExternalLink
  )
  
  if (existing) {
    ElMessage.warning('è¯¥å¤–é“¾å·²åŒæ­¥è¿‡ï¼Œä¸å†é‡å¤è¿½åŠ ')
    return
  }
  
  // ... åç»­é€»è¾‘ ...
}
```

---

### 2.10 å¹¶å‘éš”ç¦»ç­–ç•¥ âœ…

**å®ç°**ï¼šä½¿ç”¨å‘½åç©ºé—´æˆ–ç”¨æˆ·æ ‡è¯†éš”ç¦»æ•°æ®ã€‚

```javascript
// stores/adCampaign.js

// ç”Ÿæˆå”¯ä¸€çš„ç”¨æˆ·æ ‡è¯†ï¼ˆæµè§ˆå™¨æŒ‡çº¹ï¼‰
const generateUserFingerprint = () => {
  const canvas = document.createElement('canvas')
  const ctx = canvas.getContext('2d')
  ctx.textBaseline = 'top'
  ctx.font = '14px Arial'
  ctx.fillText('User fingerprint', 2, 2)
  
  const fingerprint = canvas.toDataURL()
  return btoa(fingerprint).substring(0, 16) // ç®€åŒ–ç‰ˆæŒ‡çº¹
}

// è·å–æˆ–åˆ›å»ºç”¨æˆ·æ ‡è¯†
const getUserIdentifier = () => {
  let userId = localStorage.getItem('user_fingerprint')
  if (!userId) {
    userId = generateUserFingerprint()
    localStorage.setItem('user_fingerprint', userId)
  }
  return userId
}

// åœ¨æŒä¹…åŒ–é…ç½®ä¸­ä½¿ç”¨ç”¨æˆ·æ ‡è¯†
export const useAdCampaignStore = defineStore('adCampaign', () => {
  // ... çŠ¶æ€ ...
}, {
  persist: {
    key: `ad-campaign-data-${getUserIdentifier()}`, // æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„key
    storage: window.localStorage,
    paths: ['productDataMapping', 'workflowMode', 'syncSource']
  }
})
```

---

### 2.11 å¯¼å‡ºæ–‡ä»¶å‘½å âœ…

**å®ç°**ï¼šæ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³å’Œæ“ä½œäººã€‚

```javascript
// ç”Ÿæˆè¡¨æ ¼æ—¶
const generateAllTables = async () => {
  // ... æ ¡éªŒé€»è¾‘ ...
  
  // ç”Ÿæˆæ–‡ä»¶å
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)
  const operator = formData['æ“ä½œäºº'] || 'æœªçŸ¥' // å¯ä»¥æ·»åŠ æ“ä½œäººå­—æ®µ
  const fileName = `æŠ•æ”¾è¡¨_${operator}_${timestamp}.xlsx`
  
  // ... ç”Ÿæˆè¡¨æ ¼ ...
  
  // ä¸‹è½½æ–‡ä»¶
  downloadExcelFile(tables, fileName)
}
```

---

## ä¸‰ã€å®Œæ•´Storeç»“æ„

### 3.1 adCampaign.js Store

```javascript
import { defineStore } from 'pinia'
import { ref, reactive, computed } from 'vue'
import { normalizeUrl } from '@/utils/urlNormalize'
import { useImageStitchStore } from './imageStitch'
import { ElMessage, ElMessageBox } from 'element-plus'

export const useAdCampaignStore = defineStore('adCampaign', () => {
  // ========== å·¥ä½œæµæ¨¡å¼ ==========
  const workflowMode = ref('standard') // 'standard' | 'stitch_sync'
  
  // ========== åŒæ­¥æ¥æºæ ‡è®° ==========
  const syncSource = ref('none') // 'none' | 'excel' | 'stitch'
  
  // ========== è¡¨å•æ•°æ® ==========
  const formData = reactive({
    'å•†å“ID': '',
    'å•†å“SPU': '',
    'å•†å“å›¾ç‰‡é“¾æ¥': '',
    // ... å…¶ä»–å­—æ®µ ...
  })
  
  // ========== æ•°æ®æ˜ å°„å…³ç³»ï¼ˆæŒä¹…åŒ–ï¼‰ ==========
  const productDataMapping = ref({
    // å¤–é“¾è®°å½•æ•°ç»„
    externalLinks: [],
    
    // å›¾ç‰‡é“¾æ¥åˆ°å•†å“çš„æ˜ å°„ï¼ˆkey: å½’ä¸€åŒ–åçš„URLï¼‰
    imageToProduct: {},
    
    // å•†å“IDå’Œå•†å“SPUæ•°ç»„ï¼ˆåŸå§‹æ•°æ®ï¼‰
    productIds: [],
    productSpus: []
  })
  
  // ========== æ¨¡å¼åˆ‡æ¢ ==========
  const handleModeChange = (mode) => {
    if (mode === 'standard') {
      ElMessage.info('å·²åˆ‡æ¢åˆ°æ ‡å‡†æ¨¡å¼ï¼Œå°†è·³è¿‡3:1æ ¡éªŒ')
    } else {
      ElMessage.info('å·²åˆ‡æ¢åˆ°æ‹¼å›¾å¯¹é½æ¨¡å¼ï¼Œå°†å¯ç”¨3:1å¼ºæ ¡éªŒ')
    }
  }
  
  // ========== Excelå¯¼å…¥å¤„ç† ==========
  const buildImageToProductMapping = (productIds, productSpus, productImages) => {
    productDataMapping.value.productIds = productIds
    productDataMapping.value.productSpus = productSpus
    
    const mapping = {}
    productImages.forEach((imageUrl, index) => {
      const normalizedUrl = normalizeUrl(imageUrl)
      if (normalizedUrl && productIds[index] && productSpus[index]) {
        mapping[normalizedUrl] = {
          productId: productIds[index],
          productSpu: productSpus[index]
        }
      }
    })
    
    productDataMapping.value.imageToProduct = mapping
  }
  
  // ========== æ‰«æç´ æåº“å¹¶æ‰“æ ‡ç­¾ ==========
  const scanAndTagMaterials = (productIds, productSpus, productImages) => {
    const imageStitchStore = useImageStitchStore()
    
    productImages.forEach((imageUrl, index) => {
      const normalizedUrl = normalizeUrl(imageUrl)
      const productId = productIds[index]
      const productSpu = productSpus[index]
      
      const matchedMaterial = imageStitchStore.materials.find(material => {
        const materialUrl = normalizeUrl(material.originalUrl || material.publicUrl || '')
        return materialUrl === normalizedUrl
      })
      
      if (matchedMaterial) {
        matchedMaterial.productInfo = {
          productId,
          productSpu,
          productImage: imageUrl
        }
        console.log(`âœ… [Store] ç´ æå·²æ ‡è®°: ${matchedMaterial.id} -> ${productId}/${productSpu}`)
      }
    })
  }
  
  // ========== æ·»åŠ å¤–é“¾ï¼ˆæ™ºèƒ½åˆ‡æ¢ï¼‰ ==========
  const addExternalLink = (externalLink, imageLinks) => {
    // å»é‡æ£€æŸ¥
    const normalizedExternalLink = normalizeUrl(externalLink)
    const existing = productDataMapping.value.externalLinks.find(
      item => normalizeUrl(item.externalLink) === normalizedExternalLink
    )
    
    if (existing) {
      ElMessage.warning('è¯¥å¤–é“¾å·²åŒæ­¥è¿‡ï¼Œä¸å†é‡å¤è¿½åŠ ')
      return
    }
    
    const linkRecord = {
      externalLink,
      imageLinks: imageLinks.map(item => normalizeUrl(item.link)),
      productInfo: imageLinks.map(item => item.productInfo).filter(Boolean) // å•†å“ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
    }
    
    // æ™ºèƒ½åˆ‡æ¢é€»è¾‘
    const isFirstStitchSync = syncSource.value === 'excel' || 
                             (syncSource.value === 'none' && productDataMapping.value.externalLinks.length === 0)
    
    if (isFirstStitchSync && syncSource.value === 'excel') {
      // è¦†ç›–æ¨¡å¼
      productDataMapping.value.externalLinks = [linkRecord]
      formData['å•†å“å›¾ç‰‡é“¾æ¥'] = externalLink
      ElMessage.info('é¦–æ¬¡åŒæ­¥å¤–é“¾ï¼Œå·²è¦†ç›–Excelå¯¼å…¥çš„å›¾ç‰‡é“¾æ¥')
    } else {
      // è¿½åŠ æ¨¡å¼
      productDataMapping.value.externalLinks.push(linkRecord)
      const existingLinks = formData['å•†å“å›¾ç‰‡é“¾æ¥'] ? 
        formData['å•†å“å›¾ç‰‡é“¾æ¥'].split('\n').filter(l => l.trim()) : []
      existingLinks.push(externalLink)
      formData['å•†å“å›¾ç‰‡é“¾æ¥'] = existingLinks.join('\n')
    }
    
    syncSource.value = 'stitch'
  }
  
  // ========== å¯¹é½æ•°æ® ==========
  const alignData = () => {
    if (workflowMode.value !== 'stitch_sync') {
      ElMessage.warning('è¯·å…ˆåˆ‡æ¢åˆ°æ‹¼å›¾å¯¹é½æ¨¡å¼')
      return
    }
    
    // æ ¡éªŒ
    if (!validateStrictThree()) {
      return
    }
    
    // å¯¹é½é€»è¾‘
    const externalLinks = productDataMapping.value.externalLinks || []
    const alignedProductIds = []
    const alignedProductSpus = []
    
    externalLinks.forEach((linkRecord) => {
      const { imageLinks, productInfo } = linkRecord
      
      // ä¼˜å…ˆä½¿ç”¨ç´ æè‡ªå¸¦çš„å•†å“ä¿¡æ¯
      if (productInfo && productInfo.length === 3) {
        productInfo.forEach(info => {
          alignedProductIds.push(info.productId)
          alignedProductSpus.push(info.productSpu)
        })
      } else {
        // é™çº§ï¼šé€šè¿‡å›¾ç‰‡é“¾æ¥æŸ¥æ‰¾
        imageLinks.forEach(imageLink => {
          const normalizedLink = normalizeUrl(imageLink)
          const product = productDataMapping.value.imageToProduct[normalizedLink]
          if (product) {
            alignedProductIds.push(product.productId)
            alignedProductSpus.push(product.productSpu)
          }
        })
      }
    })
    
    // æ›´æ–°è¡¨å•
    formData['å•†å“ID'] = alignedProductIds.join('\n')
    formData['å•†å“SPU'] = alignedProductSpus.join('\n')
    
    ElMessage.success('æ•°æ®å¯¹é½å®Œæˆ')
  }
  
  // ========== æ ¡éªŒå‡½æ•° ==========
  const validateStrictThree = () => {
    if (workflowMode.value !== 'stitch_sync') {
      return true
    }
    
    const externalLinks = productDataMapping.value.externalLinks || []
    const externalLinkCount = externalLinks.length
    
    const productIds = formData['å•†å“ID'] ? 
      formData['å•†å“ID'].split('\n').filter(id => id.trim()) : []
    const idCount = productIds.length
    
    if (externalLinkCount === 0) {
      ElMessage.warning('è¯·å…ˆåŒæ­¥å¤–é“¾')
      return false
    }
    
    const requiredIdCount = externalLinkCount * 3
    
    if (idCount !== requiredIdCount) {
      ElMessageBox.alert(
        `æ•°æ®ä¸åŒ¹é…ï¼\n\nå½“å‰æœ‰ ${externalLinkCount} ä¸ªå¤–é“¾ï¼Œéœ€è¦ ${requiredIdCount} ä¸ªå•†å“ä¿¡æ¯ã€‚\nä½†å®é™…æ£€æµ‹åˆ° ${idCount} ä¸ªå•†å“IDã€‚\n\nè¯·æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ã€‚`,
        'æ ¡éªŒå¤±è´¥',
        { type: 'error' }
      )
      return false
    }
    
    return true
  }
  
  const validateRowCountMatch = () => {
    const productIds = formData['å•†å“ID'] ? 
      formData['å•†å“ID'].split('\n').filter(id => id.trim()) : []
    const productSpus = formData['å•†å“SPU'] ? 
      formData['å•†å“SPU'].split('\n').filter(spu => spu.trim()) : []
    
    if (productIds.length !== productSpus.length) {
      ElMessageBox.alert(
        `æ•°æ®ä¸ä¸€è‡´ï¼\n\nå•†å“IDæœ‰ ${productIds.length} è¡Œ\nå•†å“SPUæœ‰ ${productSpus.length} è¡Œ\n\nè¯·ç¡®ä¿è¡Œæ•°ä¸€è‡´ã€‚`,
        'æ•°æ®æ ¡éªŒå¤±è´¥',
        { type: 'warning' }
      )
      return false
    }
    
    return true
  }
  
  // ========== å¯¹é½çŠ¶æ€æ£€æµ‹ ==========
  const checkAlignmentStatus = () => {
    if (workflowMode.value !== 'stitch_sync') return null
    
    const externalLinks = productDataMapping.value.externalLinks || []
    const imageToProduct = productDataMapping.value.imageToProduct || {}
    
    const groups = externalLinks.map((linkRecord) => {
      const { externalLink, imageLinks, productInfo } = linkRecord
      
      // ä¼˜å…ˆä½¿ç”¨productInfo
      let products = []
      if (productInfo && productInfo.length > 0) {
        products = productInfo.map(info => ({
          matched: true,
          id: info.productId,
          spu: info.productSpu
        }))
      } else {
        products = imageLinks.map(imageLink => {
          const normalizedLink = normalizeUrl(imageLink)
          const product = imageToProduct[normalizedLink]
          return {
            imageLink,
            matched: !!product,
            id: product?.productId || null,
            spu: product?.productSpu || null
          }
        })
      }
      
      const matchedCount = products.filter(p => p.matched).length
      const complete = matchedCount === 3
      
      return {
        externalLink,
        products,
        matched: matchedCount,
        complete
      }
    })
    
    const alignedCount = groups.filter(g => g.complete).length
    const incompleteCount = groups.filter(g => !g.complete && g.matched > 0).length
    const unmatchedCount = groups.reduce((sum, g) => {
      return sum + g.products.filter(p => !p.matched).length
    }, 0)
    
    return {
      totalGroups: groups.length,
      alignedCount,
      incompleteCount,
      unmatchedCount,
      allAligned: alignedCount === groups.length && groups.length > 0,
      groups
    }
  }
  
  return {
    // çŠ¶æ€
    workflowMode,
    syncSource,
    formData,
    productDataMapping,
    
    // æ–¹æ³•
    handleModeChange,
    buildImageToProductMapping,
    scanAndTagMaterials,
    addExternalLink,
    alignData,
    validateStrictThree,
    validateRowCountMatch,
    checkAlignmentStatus
  }
}, {
  persist: {
    key: 'ad-campaign-data',
    storage: window.localStorage,
    paths: ['productDataMapping', 'workflowMode', 'syncSource']
  }
})
```

### 3.2 imageStitch.js Storeï¼ˆå¢å¼ºç‰ˆï¼‰

```javascript
import { defineStore } from 'pinia'
import { ref, reactive, computed } from 'vue'
import { normalizeUrl } from '@/utils/urlNormalize'

export const useImageStitchStore = defineStore('imageStitch', () => {
  // ========== åŸæœ‰çŠ¶æ€ ==========
  const materials = ref([])
  const canvasSlots = reactive({
    left: null,
    topRight: null,
    bottomRight: null
  })
  
  // ... å…¶ä»–åŸæœ‰çŠ¶æ€å’Œæ–¹æ³• ...
  
  // ========== å¢å¼ºçš„addMaterialæ–¹æ³• ==========
  /**
   * æ–¹æ³•ï¼šæ·»åŠ ç´ æåˆ°åˆ—è¡¨ï¼ˆå¢å¼ºç‰ˆ - è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯ï¼‰
   * @param {Object} material - ç´ æå¯¹è±¡
   */
  const addMaterial = async (material) => {
    // 1. æ·»åŠ åˆ°ç´ æåˆ—è¡¨ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
    materials.value.push(material)
    console.log('ğŸ“¦ [ImageStitch Store] æ·»åŠ ç´ æ:', material.id)
    
    // 2. è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯ï¼ˆæ–°å¢é€»è¾‘ï¼‰
    // ä½¿ç”¨å¼‚æ­¥ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
    autoScanProductInfo(material).catch(error => {
      // é™é»˜å¤„ç†é”™è¯¯ï¼Œä¸å½±å“ç´ ææ·»åŠ 
      console.warn('âš ï¸ [ImageStitch Store] è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯å¤±è´¥:', error)
    })
  }
  
  /**
   * è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯ï¼ˆæ–°å¢æ–¹æ³•ï¼‰
   * å½“æ–°ç´ æä¸Šä¼ æ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥adCampaignStoreçš„æ˜ å°„è¡¨ï¼Œå¦‚æœåŒ¹é…å°±è‡ªåŠ¨æ‰“æ ‡ç­¾
   * @param {Object} material - ç´ æå¯¹è±¡
   */
  const autoScanProductInfo = async (material) => {
    try {
      // åŠ¨æ€å¯¼å…¥adCampaignStoreï¼ˆé¿å…å¾ªç¯ä¾èµ–ï¼‰
      const { useAdCampaignStore } = await import('./adCampaign')
      const adCampaignStore = useAdCampaignStore()
      
      // è·å–ç´ æçš„URLï¼ˆå°è¯•å¤šä¸ªå¯èƒ½çš„å­—æ®µï¼‰
      const materialUrl = material.originalUrl || material.publicUrl || material.previewUrl || ''
      if (!materialUrl) {
        return // æ²¡æœ‰URLï¼Œæ— æ³•åŒ¹é…
      }
      
      // å½’ä¸€åŒ–URL
      const normalizedUrl = normalizeUrl(materialUrl)
      if (!normalizedUrl) {
        return
      }
      
      // åœ¨adCampaignStoreçš„æ˜ å°„è¡¨ä¸­æŸ¥æ‰¾
      const imageToProduct = adCampaignStore.productDataMapping?.imageToProduct || {}
      const productInfo = imageToProduct[normalizedUrl]
      
      if (productInfo) {
        // æ‰¾åˆ°åŒ¹é…çš„å•†å“ä¿¡æ¯ï¼Œè‡ªåŠ¨æ‰“æ ‡ç­¾
        material.productInfo = {
          productId: productInfo.productId,
          productSpu: productInfo.productSpu,
          productImage: materialUrl
        }
        console.log(`âœ… [ImageStitch Store] ç´ æè‡ªåŠ¨æ ‡è®°å•†å“ä¿¡æ¯: ${material.id} -> ${productInfo.productId}/${productInfo.productSpu}`)
        
        // å¯é€‰ï¼šæ˜¾ç¤ºæç¤ºï¼ˆé¿å…è¿‡äºé¢‘ç¹çš„æç¤ºï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼‰
        // åªåœ¨ç¬¬ä¸€æ¬¡åŒ¹é…æ—¶æç¤ºï¼Œæˆ–è€…ä½¿ç”¨é˜²æŠ–
        if (!material._hasShownMatchTip) {
          // ElMessage.success(`ç´ æå·²è‡ªåŠ¨å…³è”å•†å“: ${productInfo.productId}`)
          material._hasShownMatchTip = true
        }
      } else {
        console.log(`â„¹ï¸ [ImageStitch Store] ç´ ææœªæ‰¾åˆ°åŒ¹é…çš„å•†å“ä¿¡æ¯: ${material.id}`)
      }
    } catch (error) {
      // å¦‚æœadCampaignStoreä¸å­˜åœ¨æˆ–æœªåˆå§‹åŒ–ï¼Œé™é»˜å¤±è´¥ï¼ˆä¸å½±å“ç´ ææ·»åŠ ï¼‰
      // è¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿåœ¨ï¼š
      // 1. adCampaignStoreè¿˜æœªåˆå§‹åŒ–
      // 2. ç”¨æˆ·è¿˜æ²¡æœ‰å¯¼å…¥Excelæ•°æ®
      // 3. æ¨¡å—å¯¼å…¥å¤±è´¥
      console.warn('âš ï¸ [ImageStitch Store] è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯å¤±è´¥ï¼ˆå¯èƒ½adCampaignStoreæœªåˆå§‹åŒ–ï¼‰:', error.message)
    }
  }
  
  /**
   * æ‰¹é‡æ·»åŠ ç´ æï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
   * å¦‚æœç”¨æˆ·æ‰¹é‡ä¸Šä¼ å¤šä¸ªç´ æï¼Œå¯ä»¥ä¼˜åŒ–ä¸ºæ‰¹é‡æ‰«æ
   */
  const addMaterials = (materialsArray) => {
    materialsArray.forEach(material => {
      materials.value.push(material)
      // å¼‚æ­¥æ‰«æï¼Œä¸é˜»å¡ä¸»æµç¨‹
      autoScanProductInfo(material).catch(() => {
        // é™é»˜å¤„ç†é”™è¯¯
      })
    })
    
    console.log(`ğŸ“¦ [ImageStitch Store] æ‰¹é‡æ·»åŠ  ${materialsArray.length} ä¸ªç´ æ`)
  }
  
  // ========== åŸæœ‰æ–¹æ³•ä¿æŒä¸å˜ ==========
  // removeMaterial, getMaterialById, setCanvasSlot ç­‰...
  
  return {
    // çŠ¶æ€
    materials,
    canvasSlots,
    // ... å…¶ä»–åŸæœ‰è¿”å›å€¼ ...
    
    // æ–¹æ³•
    addMaterial, // ä½¿ç”¨å¢å¼ºç‰ˆçš„addMaterial
    addMaterials, // æ–°å¢æ‰¹é‡æ·»åŠ æ–¹æ³•
    // ... å…¶ä»–åŸæœ‰æ–¹æ³• ...
  }
})
```

---

## å››ã€ç”Ÿæˆè¡¨æ ¼é€»è¾‘ï¼ˆ3:1åˆ†ç»„ï¼‰

```javascript
// views/AdCampaign.vue - generateAllTablesæ–¹æ³•

const generateAllTables = async () => {
  // 1. è¡Œæ•°ç›¸ç­‰æ ¡éªŒï¼ˆæ‰€æœ‰æ¨¡å¼ï¼‰
  if (!adCampaignStore.validateRowCountMatch()) {
    return
  }
  
  // 2. ä¸‰å€æ•°å¼ºæ ¡éªŒï¼ˆä»…æ‹¼å›¾å¯¹é½æ¨¡å¼ï¼‰
  if (workflowMode.value === 'stitch_sync') {
    if (!adCampaignStore.validateStrictThree()) {
      return
    }
  }
  
  // 3. å¤„ç†å•†å“IDå’Œå•†å“SPU
  const processedProductIds = formData['å•†å“ID'] ? 
    processMultiLineInput(formData['å•†å“ID']) : ''
  const processedProductSpus = formData['å•†å“SPU'] ? 
    processMultiLineInput(formData['å•†å“SPU']) : ''
  const processedProductImages = formData['å•†å“å›¾ç‰‡é“¾æ¥'] ? 
    processMultiLineInput(formData['å•†å“å›¾ç‰‡é“¾æ¥']) : ''
  
  const productIds = processedProductIds ? 
    processedProductIds.split('\n').filter(id => id.trim()) : []
  const productSpus = processedProductSpus ? 
    processedProductSpus.split('\n').filter(spu => spu.trim()) : []
  const productImages = processedProductImages ? 
    processedProductImages.split('\n').filter(img => img.trim()) : []
  
  // 4. æ ¹æ®æ¨¡å¼å¤„ç†æ•°æ®
  let tableData = []
  
  if (workflowMode.value === 'stitch_sync') {
    // æ‹¼å›¾å¯¹é½æ¨¡å¼ï¼š3:1åˆ†ç»„
    const externalLinkCount = productImages.length
    
    for (let i = 0; i < externalLinkCount; i++) {
      const startIndex = i * 3
      const endIndex = startIndex + 3
      
      const groupIds = productIds.slice(startIndex, endIndex)
      const groupSpus = productSpus.slice(startIndex, endIndex)
      
      if (groupIds.length === 3 && groupSpus.length === 3) {
        tableData.push({
          'å•†å“ID': groupIds.join(','), // ç”¨é€—å·è¿æ¥
          'å•†å“SPU': groupSpus.join(','), // ç”¨é€—å·è¿æ¥
          'å•†å“å›¾ç‰‡é“¾æ¥': productImages[i]
          // ... å…¶ä»–å­—æ®µ ...
        })
      }
    }
  } else {
    // æ ‡å‡†æ¨¡å¼ï¼š1:1å¯¹åº”
    const maxLength = Math.max(productIds.length, productSpus.length, productImages.length)
    
    for (let i = 0; i < maxLength; i++) {
      tableData.push({
        'å•†å“ID': productIds[i] || '',
        'å•†å“SPU': productSpus[i] || '',
        'å•†å“å›¾ç‰‡é“¾æ¥': productImages[i] || ''
        // ... å…¶ä»–å­—æ®µ ...
      })
    }
  }
  
  // 5. ç”Ÿæˆæ–‡ä»¶å
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)
  const operator = formData['æ“ä½œäºº'] || 'æœªçŸ¥'
  const fileName = `æŠ•æ”¾è¡¨_${operator}_${timestamp}.xlsx`
  
  // 6. ç”Ÿæˆå¹¶ä¸‹è½½è¡¨æ ¼
  // ... ç”ŸæˆExcelæ–‡ä»¶çš„é€»è¾‘ ...
}
```

---

## äº”ã€å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€å·¥å…·å’Œé…ç½®
1. âœ… å®‰è£…ä¾èµ–ï¼ˆxlsx, pinia-plugin-persistedstateï¼‰
2. âœ… é…ç½®PiniaæŒä¹…åŒ–æ’ä»¶
3. âœ… åˆ›å»ºURLå½’ä¸€åŒ–å·¥å…·å‡½æ•°

### é˜¶æ®µäºŒï¼šStoreç»“æ„è®¾è®¡
1. âœ… ä¿®æ”¹adCampaign.js storeï¼Œæ·»åŠ æ–°æ¨¡å¼ç›¸å…³çŠ¶æ€
2. âœ… ä¿®æ”¹imageStitch.js storeï¼Œå¢å¼ºaddMaterialæ–¹æ³•ï¼ˆè‡ªåŠ¨æ‰«æï¼‰
3. âœ… å®ç°æ¨¡å¼åˆ‡æ¢é€»è¾‘
4. âœ… å®ç°åŒæ­¥æ¥æºæ ‡è®°
5. âœ… å®ç°æ•°æ®æ˜ å°„å’Œæ‰«ææ ‡ç­¾åŠŸèƒ½

### é˜¶æ®µä¸‰ï¼šExcelå¯¼å…¥åŠŸèƒ½ï¼ˆé€šç”¨ï¼‰
1. âœ… æ·»åŠ å¯¼å…¥æŒ‰é’®
2. âœ… å®ç°Excelè§£æ
3. âœ… å®ç°è‡ªåŠ¨è¡¨å¤´è¯†åˆ«
4. âœ… å®ç°æ‰‹åŠ¨æ˜ å°„ï¼ˆå¤±è´¥æ—¶ï¼‰
5. âœ… å®ç°å¯¼å…¥é¢„è§ˆ
6. âœ… å®ç°æ•°æ®ç­›é€‰å’Œæå–
7. âœ… å®ç°æ˜ å°„å»ºç«‹å’Œç´ ææ ‡ç­¾

### é˜¶æ®µå››ï¼šå·¥ä½œæµæ¨¡å¼UI
1. âœ… æ·»åŠ æ¨¡å¼åˆ‡æ¢å¼€å…³
2. âœ… å®ç°æ¨¡å¼ç›¸å…³UIçš„æ˜¾ç¤º/éšè—
3. âœ… å®ç°å¯¹é½æŒ‰é’®ï¼ˆä»…æ‹¼å›¾æ¨¡å¼æ˜¾ç¤ºï¼‰

### é˜¶æ®µäº”ï¼šå›¾ç‰‡æ‹¼æ¥é¡µé¢æ”¹é€ 
1. âœ… ä¿®æ”¹imageStitch.js storeï¼Œæ·»åŠ æ‹¼å›¾è®°å½•
2. âœ… ä¿®æ”¹handleDropï¼Œè®°å½•å•†å“ä¿¡æ¯
3. âœ… å®ç°å¤–é“¾ä¸Šä¼ åçš„åŒæ­¥åŠŸèƒ½
4. âœ… å®ç°å»é‡æ£€æŸ¥
5. âœ… **æ–°å¢ï¼šç´ æä¸Šä¼ æ—¶è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯**

### é˜¶æ®µå…­ï¼šå¯¹é½åŠŸèƒ½
1. âœ… å®ç°å¯¹é½å…¨é€»è¾‘
2. âœ… å®ç°å¯¹é½çŠ¶æ€æ£€æµ‹
3. âœ… å®ç°å¯è§†åŒ–é¢„è§ˆè¡¨
4. âœ… å®ç°æ ¡éªŒå‡½æ•°

### é˜¶æ®µä¸ƒï¼šè¡¨æ ¼ç”Ÿæˆæ”¹é€ 
1. âœ… å®ç°3:1åˆ†ç»„é€»è¾‘ï¼ˆæ‹¼å›¾æ¨¡å¼ï¼‰
2. âœ… å®ç°1:1é€»è¾‘ï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰
3. âœ… å®ç°æ ¡éªŒæ‹¦æˆª
4. âœ… å®ç°æ–‡ä»¶å‘½åä¼˜åŒ–

### é˜¶æ®µå…«ï¼šæµ‹è¯•å’Œä¼˜åŒ–
1. âœ… åŠŸèƒ½æµ‹è¯•
2. âœ… æ¨¡å¼åˆ‡æ¢æµ‹è¯•
3. âœ… æ—¶åºæµ‹è¯•ï¼ˆå…ˆå¯¼å…¥Excel vs å…ˆä¸Šä¼ ç´ æï¼‰
4. âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•
5. âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–

---

## å…­ã€ä¼˜åŒ–å»ºè®®é‡‡çº³æƒ…å†µï¼ˆæœ€ç»ˆç‰ˆï¼‰

| ä¼˜åŒ–å»ºè®® | é‡‡çº³çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|
| 1. URLå½’ä¸€åŒ– | âœ… å®Œå…¨é‡‡çº³ | æ‰€æœ‰åŒ¹é…åœºæ™¯ä½¿ç”¨ |
| 2. çŠ¶æ€æŒä¹…åŒ– | âœ… å®Œå…¨é‡‡çº³ | ä½¿ç”¨pinia-plugin-persistedstate |
| 3. å·¥ä½œæµæ¨¡å¼åˆ‡æ¢ | âœ… å®Œå…¨é‡‡çº³ | æ ‡å‡†æ¨¡å¼ + æ‹¼å›¾å¯¹é½æ¨¡å¼ |
| 4. åŒæ­¥æ¨¡å¼æ™ºèƒ½åˆ‡æ¢ | âœ… å®Œå…¨é‡‡çº³ | è‡ªåŠ¨è¯†åˆ«é¦–æ¬¡è¦†ç›– |
| 5. ç´ æåº“æ·±åº¦ç»‘å®šï¼ˆåŒå‘ï¼‰ | âœ… å®Œå…¨é‡‡çº³ | Excelå¯¼å…¥æ—¶æ‰«æ + ç´ æä¸Šä¼ æ—¶è‡ªåŠ¨æ‰«æ |
| 6. ä¸¥æ ¼ä¸‰å€æ•°æ ¡éªŒ | âœ… å®Œå…¨é‡‡çº³ | ä»…åœ¨æ‹¼å›¾æ¨¡å¼æ ¡éªŒ |
| 7. å¯¹é½é¢„è§ˆè¡¨ | âœ… å®Œå…¨é‡‡çº³ | å¯è§†åŒ–æ˜¾ç¤ºå¯¹é½çŠ¶æ€ |
| 8. Excelæ™ºèƒ½æ˜ å°„ | âœ… å®Œå…¨é‡‡çº³ | è‡ªåŠ¨è¯†åˆ«+æ‰‹åŠ¨æ˜ å°„+é¢„è§ˆ |
| 9. å¤–é“¾å»é‡ | âœ… å®Œå…¨é‡‡çº³ | æ£€æŸ¥å·²å­˜åœ¨çš„å¤–é“¾ |
| 10. å¹¶å‘éš”ç¦» | âœ… å®Œå…¨é‡‡çº³ | ä½¿ç”¨ç”¨æˆ·æ ‡è¯†éš”ç¦» |
| 11. æ–‡ä»¶å‘½åä¼˜åŒ– | âœ… å®Œå…¨é‡‡çº³ | æ—¶é—´æˆ³+æ“ä½œäºº |
| 12. è¡Œæ•°ç›¸ç­‰æ ¡éªŒ | âœ… å®Œå…¨é‡‡çº³ | æ‰€æœ‰æ¨¡å¼é€šç”¨æ ¡éªŒ |
| 13. **è‡ªåŠ¨è§¦å‘ç´ æé‡æ‰«æ** | âœ… **æ–°å¢é‡‡çº³** | **ç´ æä¸Šä¼ æ—¶è‡ªåŠ¨æ‰«æå•†å“ä¿¡æ¯** |

---

## ä¸ƒã€æ ¸å¿ƒäº®ç‚¹æ€»ç»“

### 1. åŒå‘è‡ªåŠ¨æ‰«ææœºåˆ¶ âœ… **æ–°å¢äº®ç‚¹**
- **Excelå¯¼å…¥æ—¶**ï¼šæ‰«æç´ æåº“ï¼Œä¸ºå·²æœ‰ç´ ææ‰“æ ‡ç­¾
- **ç´ æä¸Šä¼ æ—¶**ï¼šè‡ªåŠ¨æ‰«æå•†å“æ˜ å°„è¡¨ï¼Œä¸ºæ–°ç´ ææ‰“æ ‡ç­¾
- **æ•ˆæœ**ï¼šæ— è®ºå…ˆåšä»€ä¹ˆï¼Œéƒ½èƒ½è‡ªåŠ¨åŒ¹é…ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ

### 2. åŒæ¨¡å¼æ¶æ„
- æ ‡å‡†æ¨¡å¼ï¼šä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œä¸å¼ºåˆ¶3:1æ ¡éªŒ
- æ‹¼å›¾å¯¹é½æ¨¡å¼ï¼šå¯ç”¨æ–°åŠŸèƒ½ï¼Œ3:1å¼ºæ ¡éªŒ

### 3. æ™ºèƒ½åˆ‡æ¢æœºåˆ¶
- è‡ªåŠ¨è¯†åˆ«é¦–æ¬¡åŒæ­¥éœ€è¦è¦†ç›–
- ç´ æåº“æå‰æ‰“æ ‡ç­¾ï¼Œæé«˜åŒ¹é…æ•ˆç‡

### 4. å¯è§†åŒ–åé¦ˆ
- å¯¹é½é¢„è§ˆè¡¨ï¼šå¡ç‰‡å¼å±•ç¤ºï¼Œæ¸…æ™°æ˜¾ç¤ºæ¯ç»„çš„å¯¹é½çŠ¶æ€
- çŠ¶æ€æ£€æµ‹ï¼šå®æ—¶æ˜¾ç¤ºå·²å¯¹é½ç»„æ•°ã€æœªåŒ¹é…æ•°é‡ç­‰

### 5. æ•°æ®å®Œæ•´æ€§ä¿éšœ
- ä¸¥æ ¼æ ¡éªŒï¼šä¸‰å€æ•°å¼ºæ ¡éªŒ + è¡Œæ•°ç›¸ç­‰æ ¡éªŒ
- URLå½’ä¸€åŒ–ï¼šå¤„ç†å„ç§URLæ ¼å¼å·®å¼‚
- å»é‡æœºåˆ¶ï¼šé˜²æ­¢é‡å¤æ•°æ®

### 6. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- Excelå¯¼å…¥é¢„è§ˆï¼šå¯¼å…¥å‰ç¡®è®¤
- æ‰‹åŠ¨æ˜ å°„ï¼šè‡ªåŠ¨è¯†åˆ«å¤±è´¥æ—¶æ‰‹åŠ¨é€‰æ‹©
- é”™è¯¯æç¤ºï¼šæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®®
- **å®æ—¶åŒ¹é…**ï¼šç´ æä¸Šä¼ åç«‹å³è‡ªåŠ¨å…³è”å•†å“ä¿¡æ¯

---

## å…«ã€æ³¨æ„äº‹é¡¹

1. **æ¨¡å¼éš”ç¦»**ï¼šæ ‡å‡†æ¨¡å¼å’Œæ‹¼å›¾å¯¹é½æ¨¡å¼çš„åŠŸèƒ½è¦å®Œå…¨éš”ç¦»
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å•†å“IDã€SPUã€å›¾ç‰‡é“¾æ¥çš„è¡Œæ•°ä¸€è‡´
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ‰€æœ‰æ“ä½œéƒ½è¦æœ‰æ˜ç¡®çš„åé¦ˆ
4. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯æç¤ºå’Œå¤„ç†
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§é‡æ•°æ®æ—¶çš„æ€§èƒ½è€ƒè™‘
6. **å‘åå…¼å®¹**ï¼šæ ‡å‡†æ¨¡å¼ä¿æŒåŸæœ‰åŠŸèƒ½ä¸å˜
7. **æ—¶åºæ— å…³**ï¼šæ— è®ºå…ˆå¯¼å…¥Excelè¿˜æ˜¯å…ˆä¸Šä¼ ç´ æï¼Œéƒ½èƒ½æ­£ç¡®åŒ¹é…

---

## ä¹ã€æ€»ç»“

æœ¬æœ€ç»ˆå®Œç¾ç‰ˆæ–¹æ¡ˆåœ¨åŸæœ‰åŸºç¡€ä¸Šï¼Œé‡‡çº³äº†æ‰€æœ‰ä¼˜ç§€çš„ä¼˜åŒ–å»ºè®®ï¼Œå¹¶æ–°å¢äº†**è‡ªåŠ¨è§¦å‘ç´ æé‡æ‰«æ**åŠŸèƒ½ï¼Œå®ç°äº†ï¼š

1. **åŒå‘è‡ªåŠ¨æ‰«æ**ï¼šExcelå¯¼å…¥æ—¶æ‰«æç´ æåº“ + ç´ æä¸Šä¼ æ—¶æ‰«æå•†å“æ˜ å°„è¡¨
2. **æ—¶åºæ— å…³**ï¼šæ— è®ºç”¨æˆ·å…ˆåšä»€ä¹ˆï¼Œéƒ½èƒ½è‡ªåŠ¨åŒ¹é…
3. **å®æ—¶æ€§**ï¼šæ–°ç´ æä¸Šä¼ åç«‹å³æ£€æŸ¥å¹¶æ‰“æ ‡ç­¾
4. **ç”¨æˆ·ä½“éªŒ**ï¼šæ— éœ€æ‰‹åŠ¨æ“ä½œï¼Œç³»ç»Ÿè‡ªåŠ¨å®ŒæˆåŒ¹é…

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€å¥å£®å¯é ã€ç”¨æˆ·å‹å¥½ã€æ—¶åºæ— å…³çš„å®Œç¾è§£å†³æ–¹æ¡ˆã€‚


